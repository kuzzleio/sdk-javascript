/*! Kuzzle javascript SDK version 4.0.0 */
!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.Kuzzle=t():e.Kuzzle=t()}(this,function(){return function(e){function t(i){if(r[i])return r[i].exports;var n=r[i]={exports:{},id:i,loaded:!1};return e[i].call(n.exports,n,n.exports,t),n.loaded=!0,n.exports}var r={};return t.m=e,t.c=r,t.p="",t(0)}([function(e,t,r){function i(e,t,r){var n=this;if(!(this instanceof i))return new i(e,t,r);if(r||"function"!=typeof t||(r=t,t=null),!e||""===e)throw new Error("host argument missing");return Object.defineProperties(this,{collections:{value:{},writable:!0},connectCB:{value:r},eventListeners:{value:{connected:{lastEmitted:null,listeners:[]},error:{lastEmitted:null,listeners:[]},disconnected:{lastEmitted:null,listeners:[]},reconnected:{lastEmitted:null,listeners:[]},jwtTokenExpired:{lastEmitted:null,listeners:[]},loginAttempt:{lastEmitted:null,listeners:[]},offlineQueuePush:{listeners:[]},offlineQueuePop:{listeners:[]},queryError:{listeners:[]},discarded:{listeners:[]}}},eventTimeout:{value:200},queuing:{value:!1,writable:!0},requestHistory:{value:{},writable:!0},state:{value:"initializing",writable:!0},subscriptions:{value:{pending:{}},writable:!0},autoReconnect:{value:!t||"boolean"!=typeof t.autoReconnect||t.autoReconnect,writable:!0,enumerable:!0},defaultIndex:{value:t&&"string"==typeof t.defaultIndex?t.defaultIndex:void 0,writable:!0,enumerable:!0},reconnectionDelay:{value:t&&"number"==typeof t.reconnectionDelay?t.reconnectionDelay:1e3,writable:!0,enumerable:!0},host:{value:e,writable:!0,enumerable:!0},port:{value:t&&"number"==typeof t.port?t.port:7512,enumerable:!0,writable:!0},sslConnection:{value:!(!t||"boolean"!=typeof t.sslConnection)&&t.sslConnection,writable:!0,enumerable:!0},autoQueue:{value:!1,enumerable:!0,writable:!0},autoReplay:{value:!1,enumerable:!0,writable:!0},autoResubscribe:{value:!0,enumerable:!0,writable:!0},headers:{value:{},enumerable:!0,writable:!0},volatile:{value:{},enumerable:!0,writable:!0},offlineQueue:{value:[],enumerable:!0,writable:!0},queueFilter:{value:null,enumerable:!0,writable:!0},queueMaxSize:{value:500,enumerable:!0,writable:!0},queueTTL:{value:12e4,enumerable:!0,writable:!0},replayInterval:{value:10,enumerable:!0,writable:!0},jwtToken:{value:void 0,enumerable:!0,writable:!0},offlineQueueLoader:{value:null,enumerable:!0,writable:!0}}),t&&(Object.keys(t).forEach(function(e){n.hasOwnProperty(e)&&Object.getOwnPropertyDescriptor(n,e).writable&&(n[e]=t[e])}),"auto"===t.offlineMode&&this.autoReconnect&&(this.autoQueue=this.autoReplay=this.autoResubscribe=!0)),Object.defineProperty(this,"isValid",{value:function(){if("disconnected"===n.state)throw new Error("This Kuzzle object has been invalidated. Did you try to access it after a disconnect call?")}}),Object.defineProperty(this,"addHeaders",{value:function(e,t){return Object.keys(t).forEach(function(r){e[r]||(e[r]=t[r])}),e}}),Object.defineProperty(this,"callbackRequired",{value:function(e,t){if(!t||"function"!=typeof t)throw new Error(e+": a callback argument is required for read queries")}}),Object.defineProperty(this,"security",{value:new h(this),enumerable:!0}),Object.defineProperty(this,"emitEvent",{value:function(e){var t=Date.now(),r=Array.prototype.slice.call(arguments,1),i=this.eventListeners[e];return!(i.lastEmitted&&i.lastEmitted>=t-this.eventTimeout)&&(i.listeners.forEach(function(e){setTimeout(function(){e.fn.apply(void 0,r)},0)}),void(void 0!==i.lastEmitted&&(i.lastEmitted=t)))}}),Object.defineProperty(this,"memoryStorage",{value:new p(this),enumerable:!0}),t&&t.connect&&"auto"!==t.connect?this.state="ready":this.connect(),o(this.requestHistory),this.bluebird?this.bluebird.promisifyAll(this,{suffix:"Promise",filter:function(e,t,r,i){var n=["getAllStatistics","getServerInfo","getStatistics","listCollections","listIndexes","login","logout","now","query","checkToken","whoAmI","updateSelf","getMyRights","refreshIndex","getAutoRefresh","setAutoRefresh"];return i&&n.indexOf(e)!==-1}}):void 0}function n(){var e=this,t=Date.now(),r=-1;e.queueTTL>0&&(e.offlineQueue.forEach(function(i,n){i.ts<t-e.queueTTL&&(r=n)}),r!==-1&&e.offlineQueue.splice(0,r+1).forEach(function(t){e.emitEvent("offlineQueuePop",t.query)})),e.queueMaxSize>0&&e.offlineQueue.length>e.queueMaxSize&&e.offlineQueue.splice(0,e.offlineQueue.length-e.queueMaxSize).forEach(function(t){e.emitEvent("offlineQueuePop",t.query)})}function o(e){var t=Date.now();Object.keys(e).forEach(function(r){e[r]<t-1e4&&delete e[r]}),setTimeout(function(){o(e)},1e3)}function s(e,t){var r=this;(void 0!==r.jwtToken||t)&&r.network.once(e.requestId,function(i){var n=null;"logout"!==e.action&&i.error&&"Token expired"===i.error.message&&(r.jwtToken=void 0,r.emitEvent("jwtTokenExpired",e,t)),i.error&&(n=new Error(i.error.message),Object.assign(n,i.error),n.status=i.status,r.emitEvent("queryError",n,e,t)),t&&t(n,i)}),this.network.send(e),r.requestHistory[e.requestId]=Date.now()}function u(){var e,t=this,r={},i=function(){t.offlineQueue.length>0?(s.call(t,t.offlineQueue[0].query,t.offlineQueue[0].cb),t.emitEvent("offlineQueuePop",t.offlineQueue.shift()),setTimeout(function(){i()},Math.max(0,t.replayInterval))):t.queuing=!1};if(t.offlineQueueLoader){if("function"!=typeof t.offlineQueueLoader)throw new Error("Invalid value for offlineQueueLoader property. Expected: function. Got: "+typeof t.offlineQueueLoader);if(e=t.offlineQueueLoader(),!Array.isArray(e))throw new Error("Invalid value returned by the offlineQueueLoader function. Expected: array. Got: "+typeof e);t.offlineQueue=e.concat(t.offlineQueue).filter(function(e){if(!e.query||void 0===e.query.requestId||!e.query.action||!e.query.controller)throw new Error("Invalid offline queue request. One or more missing properties: requestId, action, controller.");return!r.hasOwnProperty(e.query.requestId)&&(r[e.query.requestId]=!0)})}i()}function l(){var e=this;Object.keys(e.subscriptions).forEach(function(t){Object.keys(e.subscriptions[t]).forEach(function(r){var i=e.subscriptions[t][r];i.renew(i.callback)})})}function c(){var e=this;Object.keys(e.subscriptions).forEach(function(t){Object.keys(e.subscriptions[t]).forEach(function(r){var i=e.subscriptions[t][r];i.unsubscribe()})})}function a(e,t){t&&t(new Error("Unable to execute request: not connected to a Kuzzle server.\nDiscarded request: "+JSON.stringify(e)))}var d=r(5),f=r(8),h=r(18),p=r(10),y=r(4),b=r(14);i.prototype.connect=function(){var e=this;return e.network&&e.disconnect(),e.network=b(e.host,e.port,e.sslConnection),["initializing","ready","disconnected","error","offline"].indexOf(this.state)===-1?(e.connectCB&&e.connectCB(null,e),e):(e.state="connecting",e.network.connect(e.autoReconnect,e.reconnectionDelay),e.network.onConnect(function(){e.state="connected",l.call(e),u.call(e),e.emitEvent("connected"),e.connectCB&&e.connectCB(null,e)}),e.network.on("discarded",function(t){e.emitEvent("discarded",t)}),e.network.onConnectError(function(t){var r=new Error('Unable to connect to kuzzle proxy server at "'+e.host+'"');r.internal=t,e.state="error",e.emitEvent("error",r),e.connectCB&&e.connectCB(r)}),e.network.onDisconnect(function(){e.state="offline",e.autoReconnect||e.disconnect(),e.autoQueue&&(e.queuing=!0),e.emitEvent("disconnected")}),e.network.onReconnect(function(){var t=function(){e.autoResubscribe&&l.call(e),e.autoReplay&&(n.call(e),u.call(e)),e.emitEvent("reconnected")};e.state="connected",e.jwtToken?e.checkToken(e.jwtToken,function(r,i){!r&&i.valid||(e.jwtToken=void 0,e.emitEvent("jwtTokenExpired")),t()}):t()}),this)},i.prototype.setJwtToken=function(e){if("string"==typeof e)this.jwtToken=e;else{if("object"!=typeof e)return this.emitEvent("loginAttempt",{success:!1,error:"Invalid token argument: "+e}),this;if(!e.result||!e.result.jwt||"string"!=typeof e.result.jwt)return this.emitEvent("loginAttempt",{success:!1,error:"Cannot find a valid JWT token in the following object: "+JSON.stringify(e)}),this;this.jwtToken=e.result.jwt}return l.call(this),this.emitEvent("loginAttempt",{success:!0}),this},i.prototype.unsetJwtToken=function(){return this.jwtToken=void 0,c.call(this),this},i.prototype.getJwtToken=function(){return this.jwtToken},i.prototype.login=function(e){var t,r=this,i={strategy:e},n=null;arguments[1]&&("object"==typeof arguments[1]?t=arguments[1]:"number"==typeof arguments[1]||"string"==typeof arguments[1]?i.expiresIn=arguments[1]:"function"==typeof arguments[1]&&(n=arguments[1])),arguments[2]&&("number"==typeof arguments[2]||"string"==typeof arguments[2]?i.expiresIn=arguments[2]:"function"==typeof arguments[2]&&(n=arguments[2])),arguments[3]&&"function"==typeof arguments[3]&&(n=arguments[3]),"object"==typeof t&&Object.keys(t).forEach(function(e){i[e]=t[e]}),this.query({controller:"auth",action:"login"},{body:i},{queuable:!1},function(e,t){e?(n&&n(e),r.emitEvent("loginAttempt",{success:!1,error:e.message})):(t.result.jwt&&r.setJwtToken(t.result.jwt),n&&n(null,t.result))})},i.prototype.createIndex=function(e,t,r){if(!e){if(!this.defaultIndex)throw new Error("Kuzzle.createIndex: index required");e=this.defaultIndex}return r||"function"!=typeof t||(r=t,t=null),this.query({controller:"index",action:"create"},{index:e},t,"function"!=typeof r?null:r),this},i.prototype.logout=function(e){var t=this,r={action:"logout",controller:"auth",requestId:d.v4(),body:{}};return this.query({controller:"auth",action:"logout"},r,{queuable:!1},"function"!=typeof e?null:function(r){e(r,t)}),t.unsetJwtToken(),t},i.prototype.checkToken=function(e,t){var r={body:{token:e}};this.callbackRequired("Kuzzle.checkToken",t),this.query({controller:"auth",action:"checkToken"},r,{queuable:!1},function(e,r){return e?t(e):void t(null,r.result)})},i.prototype.whoAmI=function(e){var t=this;t.callbackRequired("Kuzzle.whoAmI",e),t.query({controller:"auth",action:"getCurrentUser"},{},{},function(r,i){return r?e(r):void e(null,new y(t.security,i.result._id,i.result._source))})},i.prototype.getMyRights=function(e,t){var r=this;t||"function"!=typeof e||(t=e,e=null),r.callbackRequired("Kuzzle.getMyRights",t),r.query({controller:"auth",action:"getMyRights"},{},e,function(e,r){return e?t(e):void t(null,r.result.hits)})},i.prototype.updateSelf=function(e,t,r){var i=this,n={},o={controller:"auth",action:"updateSelf"};return r||"function"!=typeof t||(r=t,t=null),n.body=e,i.query(o,n,t,r&&function(e,t){r(e,e?void 0:t.result)}),this},i.prototype.addListener=function(e,t){var r,i=Object.keys(this.eventListeners),n=typeof t;if(this.isValid(),i.indexOf(e)===-1)throw new Error("["+e+"] is not a known event. Known events: "+i.toString());if("function"!==n)throw new Error("Invalid listener type: expected a function, got a "+n);return r=d.v4(),this.eventListeners[e].listeners.push({id:r,fn:t}),r},i.prototype.getAllStatistics=function(e,t){t||"function"!=typeof e||(t=e,e=null),this.callbackRequired("Kuzzle.getAllStatistics",t),this.query({controller:"server",action:"getAllStats"},{},e,function(e,r){return e?t(e):void t(null,r.result.hits)})},i.prototype.getStatistics=function(e,t,r){var i,n;r||(1===arguments.length?(r=arguments[0],t=null,e=null):(r=arguments[1],"object"==typeof arguments[0]?(t=arguments[0],e=null):(e=arguments[0],t=null))),i=function(t,i){return t?r(t):void r(null,e?i.result.hits:[i.result])},this.callbackRequired("Kuzzle.getStatistics",r),n=e?{body:{startTime:e}}:{},this.query({controller:"server",action:e?"getStats":"getLastStats"},n,t,i)},i.prototype.collection=function(e,t){if(this.isValid(),!t){if(!this.defaultIndex)throw new Error("Unable to create a new data collection object: no index specified");t=this.defaultIndex}if("string"!=typeof t||"string"!=typeof e)throw new Error("Invalid index or collection argument: string expected");return this.collections[t]||(this.collections[t]={}),this.collections[t][e]||(this.collections[t][e]=new f(this,e,t)),this.collections[t][e]},i.prototype.flushQueue=function(){return this.offlineQueue=[],this},i.prototype.listCollections=function(){var e,t,r,i,n="all",o=Array.prototype.slice.call(arguments);if(o.forEach(function(i){switch(typeof i){case"string":e=i;break;case"object":t=i;break;case"function":r=i}}),!e){if(!this.defaultIndex)throw new Error("Kuzzle.listCollections: index required");e=this.defaultIndex}this.callbackRequired("Kuzzle.listCollections",r),t&&t.type&&(n=t.type),i={body:{type:n}},t&&t.from&&(i.body.from=t.from),t&&t.size&&(i.body.size=t.size),this.query({index:e,controller:"collection",action:"list"},i,t,function(e,t){return e?r(e):void r(null,t.result.collections)})},i.prototype.listIndexes=function(e,t){t||"function"!=typeof e||(t=e,e=null),this.callbackRequired("Kuzzle.listIndexes",t),this.query({controller:"index",action:"list"},{},e,function(e,r){t(e,e?void 0:r.result.indexes)})},i.prototype.disconnect=function(){var e;this.state="disconnected",this.network.close(),this.network=null;for(e in this.collections)this.collections.hasOwnProperty(e)&&delete this.collections[e]},i.prototype.getServerInfo=function(e,t){t||"function"!=typeof e||(t=e,e=null),this.callbackRequired("Kuzzle.getServerInfo",t),this.query({controller:"server",action:"info"},{},e,function(e,r){return e?t(e):void t(null,r.result.serverInfo)})},i.prototype.refreshIndex=function(){var e,t,r;if(Array.prototype.slice.call(arguments).forEach(function(i){switch(typeof i){case"string":e=i;break;case"object":t=i;break;case"function":r=i}}),!e){if(!this.defaultIndex)throw new Error("Kuzzle.refreshIndex: index required");e=this.defaultIndex}return this.query({index:e,controller:"index",action:"refresh"},{},t,r),this},i.prototype.getAutoRefresh=function(){var e,t,r;if(Array.prototype.slice.call(arguments).forEach(function(i){switch(typeof i){case"string":e=i;break;case"object":t=i;break;case"function":r=i}}),!e){if(!this.defaultIndex)throw new Error("Kuzzle.getAutoRefresh: index required");e=this.defaultIndex}this.callbackRequired("Kuzzle.getAutoRefresh",r),this.query({index:e,controller:"index",action:"getAutoRefresh"},{},t,r)},i.prototype.setAutoRefresh=function(){var e,t,r,i;if(Array.prototype.slice.call(arguments).forEach(function(n){switch(typeof n){case"string":e=n;break;case"boolean":t=n;break;case"object":r=n;break;case"function":i=n}}),!e){if(!this.defaultIndex)throw new Error("Kuzzle.setAutoRefresh: index required");e=this.defaultIndex}if(void 0===t)throw new Error("Kuzzle.setAutoRefresh: autoRefresh value is required");return this.query({index:e,controller:"index",action:"setAutoRefresh"},{body:{autoRefresh:t}},r,i),this},i.prototype.now=function(e,t){t||"function"!=typeof e||(t=e,e=null),this.callbackRequired("Kuzzle.now",t),this.query({controller:"server",action:"now"},{},e,function(e,r){t(e,r&&r.result.now)})},i.prototype.query=function(e,t,r,i){var o,u={action:e.action,controller:e.controller,volatile:this.volatile},l=this;if(this.isValid(),i||"function"!=typeof r||(i=r,r=null),r){if(r.queuable===!1&&"offline"===l.state)return l;r.refresh&&(u.refresh=r.refresh),"undefined"!=typeof r.from&&null!==r.from&&(u.from=r.from),r.size&&(u.size=r.size),r.scroll&&(u.scroll=r.scroll),r.scrollId&&(u.scrollId=r.scrollId),r.volatile&&Object.keys(r.volatile).forEach(function(e){u.volatile[e]=r.volatile[e]})}if(!t||"object"!=typeof t||Array.isArray(t))throw new Error("Invalid query parameter: "+t);t.volatile&&Object.keys(t.volatile).forEach(function(e){u.volatile[e]=t.volatile[e]});for(o in t)"volatile"!==o&&t.hasOwnProperty(o)&&(u[o]=t[o]);return u=l.addHeaders(u,this.headers),void 0===l.jwtToken||"auth"===u.controller&&"checkToken"===u.action||(u.jwt=l.jwtToken),e.collection&&(u.collection=e.collection),e.index&&(u.index=e.index),u.requestId||(u.requestId=d.v4()),"connected"===l.state||r&&r.queuable===!1?"connected"===l.state?s.call(this,u,i):a(u,i):l.queuing||r&&r.queuable===!0||["initializing","connecting"].indexOf(l.state)!==-1?(n.call(this,u,i),l.queueFilter&&!l.queueFilter(u)||(l.offlineQueue.push({ts:Date.now(),query:u,cb:i}),l.emitEvent("offlineQueuePush",{query:u,cb:i}))):a(u,i),l},i.prototype.removeAllListeners=function(e){var t=Object.keys(this.eventListeners),r=this;if(e){if(t.indexOf(e)===-1)throw new Error("["+e+"] is not a known event. Known events: "+t.toString());this.eventListeners[e].listeners=[]}else t.forEach(function(e){r.eventListeners[e].listeners=[]});return this},i.prototype.removeListener=function(e,t){var r=Object.keys(this.eventListeners),i=this;if(r.indexOf(e)===-1)throw new Error("["+e+"] is not a known event. Known events: "+r.toString());return this.eventListeners[e].listeners.forEach(function(r,n){r.id===t&&i.eventListeners[e].listeners.splice(n,1)}),this},i.prototype.replayQueue=function(){return"offline"===this.state||this.autoReplay||(n.call(this),u.call(this)),this},i.prototype.setDefaultIndex=function(e){if("string"!=typeof e)throw new Error("Invalid default index: ["+e+"] (an index name is expected)");if(0===e.length)throw new Error("Cannot set an empty index as the default index");return this.defaultIndex=e,this},i.prototype.setHeaders=function(e,t){var r=this;if("object"!=typeof e||Array.isArray(e))throw new Error("Expected a content object, received a "+typeof e);return t?r.headers=e:Object.keys(e).forEach(function(t){r.headers[t]=e[t]}),r},i.prototype.startQueuing=function(){return"offline"!==this.state||this.autoQueue||(this.queuing=!0),this},i.prototype.stopQueuing=function(){return"offline"!==this.state||this.autoQueue||(this.queuing=!1),this},e.exports=i},function(e,t){function r(e,t,r){if(!t)throw new Error("A security document must have an id");if(Object.defineProperties(this,{kuzzle:{value:e.kuzzle},Security:{value:e},id:{value:t,enumerable:!0},content:{value:{},writable:!0,enumerable:!0}}),r&&this.setContent(r,!0),e.kuzzle.bluebird)return e.kuzzle.bluebird.promisifyAll(this,{suffix:"Promise",filter:function(e,t,r,i){var n=["delete","update"];return i&&n.indexOf(e)!==-1}})}r.prototype.setContent=function(e){return this.content=e,this},r.prototype.serialize=function(){var e={};return this.id&&(e._id=this.id),e.body=this.content,e},r.prototype.delete=function(e,t){var r=this;e&&void 0===t&&"function"==typeof e&&(t=e,e=null),r.kuzzle.query(this.Security.buildQueryArgs(this.deleteActionName),{_id:this.id},e,function(e,r){return e?!!t&&t(e):void(t&&t(null,r.result._id))})},r.prototype.update=function(e,t,r){var i={},n=this;if("object"!=typeof e)throw new Error('Parameter "content" must be a object');return t&&void 0===r&&"function"==typeof t&&(r=t,t=null),i._id=n.id,i.body=e,n.kuzzle.query(this.Security.buildQueryArgs(this.updateActionName),i,t,function(e,t){return e?!!r&&r(e):(n.setContent(t.result._source),void(r&&r(null,n)))}),this},e.exports=r},function(e,t){function r(e,t,r){return Object.defineProperties(this,{collection:{value:e.collection,enumerable:!0},dataCollection:{value:e,enumerable:!1},kuzzle:{value:e.kuzzle,enumerable:!1},id:{value:void 0,enumerable:!0,writable:!0},content:{value:{},writable:!0,enumerable:!0},headers:{value:JSON.parse(JSON.stringify(e.headers)),enumerable:!0,writable:!0},version:{value:void 0,enumerable:!0,writable:!0}}),!r&&t&&"object"==typeof t&&(r=t,t=null),r&&(r._version&&(this.version=r._version,delete r._version),this.setContent(r,!0)),t&&Object.defineProperty(this,"id",{value:t,enumerable:!0}),this.kuzzle.bluebird?this.kuzzle.bluebird.promisifyAll(this,{suffix:"Promise",filter:function(e,t,r,i){var n=["delete","refresh","save"];return i&&n.indexOf(e)!==-1}}):this}r.prototype.serialize=function(){var e={};return this.id&&(e._id=this.id),e.body=this.content,e._version=this.version,e=this.kuzzle.addHeaders(e,this.headers)},r.prototype.toString=function(){return JSON.stringify(this.serialize())},r.prototype.delete=function(e,t){var r=this;if(t||"function"!=typeof e||(t=e,e=null),!r.id)throw new Error("Document.delete: cannot delete a document without a document ID");this.kuzzle.query(this.dataCollection.buildQueryArgs("document","delete"),this.serialize(),e,t&&function(e){t(e,e?void 0:r.id)})},r.prototype.refresh=function(e,t){var i=this;if(t||"function"!=typeof e||(t=e,e=null),!i.id)throw new Error("Document.refresh: cannot retrieve a document if no ID has been provided");this.kuzzle.callbackRequired("Document.refresh",t),i.kuzzle.query(i.dataCollection.buildQueryArgs("document","get"),{_id:i.id},e,function(e,n){var o;return e?t(e):(o=new r(i.dataCollection,i.id,n.result._source),o.version=n.result._version,void t(null,o))})},r.prototype.save=function(e,t){var r=this.serialize(),i=this;return e&&void 0===t&&"function"==typeof e&&(t=e,e=null),i.kuzzle.query(this.dataCollection.buildQueryArgs("document","createOrReplace"),r,e,function(e,r){return e?t&&t(e):(i.id=r.result._id,i.version=r.result._version,void(t&&t(null,i)))}),i},r.prototype.publish=function(e){var t=this.serialize();return this.kuzzle.query(this.dataCollection.buildQueryArgs("realtime","publish"),t,e),this},r.prototype.setContent=function(e,t){var r=this;return t?this.content=e:Object.keys(e).forEach(function(t){r.content[t]=e[t]}),this},r.prototype.subscribe=function(e,t){var r;if(e&&!t&&"function"==typeof e&&(t=e,e=null),this.kuzzle.callbackRequired("Document.subscribe",t),!this.id)throw new Error("Document.subscribe: cannot subscribe to a document if no ID has been provided");return r={ids:{values:[this.id]}},this.dataCollection.subscribe(r,e,t)},r.prototype.setHeaders=function(e,t){return this.kuzzle.setHeaders.call(this,e,t),this},e.exports=r},function(e,t,r){function i(e,t,i){var s=this;this.WebSocket="undefined"!=typeof WebSocket?WebSocket:r(!function(){var e=new Error('Cannot find module "ws"');throw e.code="MODULE_NOT_FOUND",e}()),this.host=e,this.port=t,this.ssl=i,this.client=null,this.wasConnected=!1,this.retrying=!1,this.lasturl=null,this.stopRetryingToConnect=!1,this.listeners={error:[],connect:[],disconnect:[],reconnect:[]},this.connect=function(e,t){var r=(this.ssl?"wss://":"ws://")+this.host+":"+this.port,i="undefined"!=typeof window?void 0:{perMessageDeflate:!1};r!==this.lasturl&&(s.wasConnected=!1,this.lasturl=r),this.client=new this.WebSocket(r,i),this.client.onopen=function(){s.wasConnected?n(s.listeners,"reconnect"):n(s.listeners,"connect"),s.wasConnected=!0,s.stopRetryingToConnect=!1},this.client.onclose=function(r,i){1e3===r?n(s.listeners,"disconnect"):o.call(s,e,t,i)},this.client.onerror=function(r){o.call(s,e,t,r)},this.client.onmessage=function(e){var t=JSON.parse(e.data||e);t.room&&s.listeners[t.room]?n(s.listeners,t.room,t):s.listeners.discarded&&n(s.listeners,"discarded",t)}},this.onConnect=function(e){this.listeners.connect.push({fn:e,keep:!0})},this.onConnectError=function(e){this.listeners.error.push({fn:e,keep:!0})},this.onDisconnect=function(e){this.listeners.disconnect.push({fn:e,keep:!0})},this.onReconnect=function(e){this.listeners.reconnect.push({fn:e,keep:!0})},this.once=function(e,t){this.listeners[e]||(this.listeners[e]=[]),this.listeners[e].push({fn:t,keep:!1})},this.on=function(e,t){this.listeners[e]||(this.listeners[e]=[]),this.listeners[e].push({fn:t,keep:!0})},this.off=function(e,t){var r=-1;this.listeners[e]&&(this.listeners[e].some(function(e,i){return e.fn===t&&(r=i,!0)}),r!==-1&&(1===this.listeners[e].length&&["error","connect","disconnect","reconnect"].indexOf(e)===-1?delete this.listeners[e]:this.listeners[e].splice(r,1)))},this.send=function(e){this.client&&this.client.readyState===this.client.OPEN&&this.client.send(JSON.stringify(e))},this.close=function(){this.listeners={error:[],connect:[],disconnect:[],reconnect:[]},this.wasConnected=!1,this.client.close(),this.client=null,s.stopRetryingToConnect=!0}}function n(e,t,r){var i,n=e[t].length;for(i=0;i<n;++i)e[t][i].fn(r),e[t][i].keep||(e[t].length>1?(e[t].splice(i,1),--i,--n):delete e[t])}function o(e,t,r){var i=this;!e||i.retrying||i.stopRetryingToConnect||(i.retrying=!0,setTimeout(function(){i.retrying=!1,i.connect(e,t)},t)),n(i.listeners,"error",r)}e.exports=i},function(e,t,r){function i(e,t,r){if(n.call(this,e,t,r),Object.defineProperties(this,{deleteActionName:{value:"deleteUser"},updateActionName:{value:"updateUser"}}),e.kuzzle.bluebird)return e.kuzzle.bluebird.promisifyAll(this,{suffix:"Promise",filter:function(e,t,r,i){var n=["save","saveRestricted"];return i&&n.indexOf(e)!==-1}})}var n=r(1);i.prototype=Object.create(n.prototype,{constructor:{value:i}}),i.prototype.setProfiles=function(e){if(!Array.isArray(e)||"string"!=typeof e[0])throw new Error('Parameter "profileIds" must be an array of strings');return this.content.profileIds=e,this},i.prototype.addProfile=function(e){if("string"!=typeof e)throw new Error('Parameter "profileId" must be a string');return this.content.profileIds||(this.content.profileIds=[]),this.content.profileIds.indexOf(e)===-1&&this.content.profileIds.push(e),this},i.prototype.save=function(e,t){var r=this.serialize(),i=this;return e&&void 0===t&&"function"==typeof e&&(t=e,e=null),i.kuzzle.query(this.Security.buildQueryArgs("createOrReplaceUser"),r,e,t&&function(e){t(e,e?void 0:i)}),i},i.prototype.saveRestricted=function(e,t){var r=this.serialize(),i=this;return e&&void 0===t&&"function"==typeof e&&(t=e,e=null),i.kuzzle.query(this.Security.buildQueryArgs("createRestrictedUser"),r,e,t&&function(e){t(e,e?void 0:i)}),i},i.prototype.serialize=function(){return{_id:this.id,body:this.content}},i.prototype.getProfiles=function(){return this.content.profileIds},e.exports=i},function(e,t,r){var i=r(19),n=r(20),o=n;o.v1=i,o.v4=n,e.exports=o},function(e,t){function r(e,t){var r=t||0,n=i;return n[e[r++]]+n[e[r++]]+n[e[r++]]+n[e[r++]]+"-"+n[e[r++]]+n[e[r++]]+"-"+n[e[r++]]+n[e[r++]]+"-"+n[e[r++]]+n[e[r++]]+"-"+n[e[r++]]+n[e[r++]]+n[e[r++]]+n[e[r++]]+n[e[r++]]+n[e[r++]]}for(var i=[],n=0;n<256;++n)i[n]=(n+256).toString(16).substr(1);e.exports=r},function(e,t,r){var i,n=window.crypto||window.msCrypto;if(n&&n.getRandomValues){var o=new Uint8Array(16);i=function(){return n.getRandomValues(o),o}}if(!i){var s=new Array(16);i=function(){for(var e,t=0;t<16;t++)0===(3&t)&&(e=4294967296*Math.random()),s[t]=e>>>((3&t)<<3)&255;return s}}e.exports=i},function(e,t,r){function i(e,t,r){if(!r||!t)throw new Error("The Collection object constructor needs an index and a collection arguments");return Object.defineProperties(this,{collection:{value:t,enumerable:!0},index:{value:r,enumerable:!0},kuzzle:{value:e,enumerable:!0},headers:{value:JSON.parse(JSON.stringify(e.headers)),enumerable:!0,writable:!0}}),Object.defineProperty(this,"buildQueryArgs",{value:function(e,t){return{controller:e,action:t,collection:this.collection,index:this.index}}}),this.kuzzle.bluebird?this.kuzzle.bluebird.promisifyAll(this,{suffix:"Promise",filter:function(e,t,r,i){var n=["publishMessage","setHeaders","subscribe"];return i&&n.indexOf(e)===-1}}):this}var n=r(12),o=r(2),s=r(9),u=r(11),l=r(13);i.prototype.count=function(e,t,r){var i;r||"function"!=typeof t||(r=t,t=null),this.kuzzle.callbackRequired("Collection.count",r),i=this.kuzzle.addHeaders({body:e},this.headers),this.kuzzle.query(this.buildQueryArgs("document","count"),i,t,function(e,t){r(e,t&&t.result.count)})},i.prototype.create=function(e,t){var r={};return t||"function"!=typeof e||(t=e,e=null),r=this.kuzzle.addHeaders(r,this.headers),this.kuzzle.query(this.buildQueryArgs("collection","create"),r,e,t),this},i.prototype.createDocument=function(e,t,r,i){var n=this,s={},u="create";if(e&&"string"!=typeof e&&(i=r,r=t,t=e,e=null),i||"function"!=typeof r||(i=r,r=null),t instanceof o?s=t.serialize():s.body=t,r&&r.ifExist)if("replace"===r.ifExist)u="createOrReplace";else if("error"!==r.ifExist)throw new Error('Invalid value for the "ifExist" option: '+r.ifExist);return e&&(s._id=e),s=n.kuzzle.addHeaders(s,n.headers),n.kuzzle.query(this.buildQueryArgs("document",u),s,r,i&&function(e,t){var r;return e?i(e):(r=new o(n,t.result._id,t.result._source),r.version=t.result._version,void i(null,r))}),this},i.prototype.deleteDocument=function(e,t,r){var i,n={};return"string"==typeof e?(n._id=e,i="delete"):(n.body={query:e},i="deleteByQuery"),r||"function"!=typeof t||(r=t,t=null),n=this.kuzzle.addHeaders(n,this.headers),this.kuzzle.query(this.buildQueryArgs("document",i),n,t,r&&function(e,t){e?r(e):r(null,"delete"===i?[t.result._id]:t.result.ids)}),this},i.prototype.fetchDocument=function(e,t,r){var i={_id:e},n=this;r||"function"!=typeof t||(r=t,t=null),n.kuzzle.callbackRequired("Collection.fetch",r),i=n.kuzzle.addHeaders(i,this.headers),n.kuzzle.query(this.buildQueryArgs("document","get"),i,t,function(e,t){var i;return e?r(e):(i=new o(n,t.result._id,t.result._source),i.version=t.result._version,void r(null,i))})},i.prototype.fetchAllDocuments=function(e,t){var r=!1,i=[],o={};t||"function"!=typeof e||(t=e,e={}),e||(e={}),e.from||(e.from=0),e.size||(e.size=1e3),this.kuzzle.callbackRequired("Collection.fetchAllDocuments",t),this.search(o,e,function e(o,s){return o?t(o):void(s instanceof n?(s.total>1e4&&!r&&(r=!0,console.warn("Collection.fetchAllDocuments may return extremely large amounts of documents, which may cause performance issues. Unless you know what you are doing, consider using Collection.search or Collection.scroll instead")),s.documents.forEach(function(e){i.push(e)}),s.fetchNext(e)):t(null,i))})},i.prototype.getMapping=function(e,t){var r;t||"function"!=typeof e||(t=e,e=null),this.kuzzle.callbackRequired("Collection.getMapping",t),r=new s(this),r.refresh(e,t)},i.prototype.publishMessage=function(e,t,r){var i={};return e instanceof o?i=e.serialize():i.body=e,i=this.kuzzle.addHeaders(i,this.headers),this.kuzzle.query(this.buildQueryArgs("realtime","publish"),i,t,r),this},i.prototype.replaceDocument=function(e,t,r,i){var n=this,s={_id:e,body:t};return i||"function"!=typeof r||(i=r,r=null),s=n.kuzzle.addHeaders(s,this.headers),n.kuzzle.query(this.buildQueryArgs("document","createOrReplace"),s,r,i&&function(e,t){var r;return e?i(e):(r=new o(n,t.result._id,t.result._source),r.version=t.result._version,void i(null,r))}),this},i.prototype.search=function(e,t,r){var i,s=this;r||"function"!=typeof t||(r=t,t={}),s.kuzzle.callbackRequired("Collection.search",r),i=s.kuzzle.addHeaders({body:e},this.headers),s.kuzzle.query(this.buildQueryArgs("document","search"),i,t,function(i,u){var l=[];return i?r(i):(u.result.hits.forEach(function(e){var t=new o(s,e._id,e._source);t.version=e._version,l.push(t)}),u.result._scroll_id&&(t.scrollId=u.result._scroll_id),void r(null,new n(s,u.result.total,l,u.result.aggregations?u.result.aggregations:{},t,e,t.previous||null)))})},i.prototype.scroll=function(e,t,r,i){var s={},u=this;if(!e)throw new Error("Collection.scroll: scrollId is required");return i||(i=r,r=null),i||"function"!=typeof t||(i=t,t={}),this.kuzzle.callbackRequired("Collection.scroll",i),s.scrollId=e,t&&t.scroll&&(s.scroll=t.scroll),this.kuzzle.query({controller:"document",action:"scroll"},s,t,function(e,s){var l=[];return e?i(e):(s.result.hits.forEach(function(e){var t=new o(u,e._id,e._source);t.version=e._version,l.push(t)}),s.result._scroll_id&&(t.scrollId=s.result._scroll_id),void i(null,new n(u,s.result.total,l,{},t,r,t.previous||null)))}),this},i.prototype.subscribe=function(e,t,r){var i,n;return r||"function"!=typeof t||(r=t,t=null),this.kuzzle.callbackRequired("Collection.subscribe",r),n=new l,i=new u(this,t),i.renew(e,r,n.done.bind(n)),n},i.prototype.truncate=function(e,t){var r={};return t||"function"!=typeof e||(t=e,e=null),r=this.kuzzle.addHeaders(r,this.headers),this.kuzzle.query(this.buildQueryArgs("collection","truncate"),r,e,t),this},i.prototype.updateDocument=function(e,t,r,i){var n={_id:e,body:t},s=this;return i||"function"!=typeof r||(i=r,r=null),r&&r.retryOnConflict&&(n.retryOnConflict=r.retryOnConflict),n=s.kuzzle.addHeaders(n,this.headers),s.kuzzle.query(this.buildQueryArgs("document","update"),n,r,i&&function(e,t){return e?i(e):void new o(s,t.result._id).refresh(i)}),s},i.prototype.document=function(e,t){return new o(this,e,t)},i.prototype.room=function(e){return new u(this,e)},i.prototype.collectionMapping=function(e){return new s(this,e)},i.prototype.setHeaders=function(e,t){return this.kuzzle.setHeaders.call(this,e,t),
this},e.exports=i},function(e,t){function r(e,t){return Object.defineProperties(this,{collection:{value:e,enumerable:!0},kuzzle:{value:e.kuzzle,enumerable:!0},headers:{value:JSON.parse(JSON.stringify(e.headers)),enumerable:!0,writable:!0},mapping:{value:t||{},enumerable:!0,writable:!0}}),this.kuzzle.bluebird?this.kuzzle.bluebird.promisifyAll(this,{suffix:"Promise",filter:function(e,t,r,i){var n=["set","setHeaders"];return i&&n.indexOf(e)===-1}}):this}r.prototype.apply=function(e,t){var r=this,i=this.kuzzle.addHeaders({body:{properties:this.mapping}},this.headers);return t||"function"!=typeof e||(t=e,e=null),r.kuzzle.query(this.collection.buildQueryArgs("collection","updateMapping"),i,e,function(i){return i?t&&t(i):void r.refresh(e,t)}),this},r.prototype.refresh=function(e,t){var r=this,i=this.kuzzle.addHeaders({},this.headers);return t||"function"!=typeof e||(t=e,e=null),this.kuzzle.query(this.collection.buildQueryArgs("collection","getMapping"),i,e,function(e,i){return e?!!t&&t(e):i.result[r.collection.index]?i.result[r.collection.index].mappings[r.collection.collection]?(r.mapping=i.result[r.collection.index].mappings[r.collection.collection].properties,void 0===r.mapping&&(r.mapping={}),void(t&&t(null,r))):t&&t(new Error("No mapping found for collection "+r.collection.collection)):t&&t(new Error("No mapping found for index "+r.collection.index))}),this},r.prototype.set=function(e,t){return this.mapping[e]=t,this},r.prototype.setHeaders=function(e,t){return this.kuzzle.setHeaders.call(this,e,t),this},e.exports=r},function(e,t){function r(e){return Object.defineProperties(this,{kuzzle:{value:e,enumerable:!0},headers:{value:JSON.parse(JSON.stringify(e.headers)),enumerable:!0,writable:!0}}),this.setHeaders=e.setHeaders.bind(this),this.kuzzle.bluebird?this.kuzzle.bluebird.promisifyAll(this,{suffix:"Promise",filter:function(e,t,r,i){var n=["setHeaders"];return i&&n.indexOf(e)===-1}}):this}function i(e,t,r,i){t||"_id"===r?e[r]=i:e.body[r]=i}function n(e,t){var r=[];Object.keys(t).filter(function(e){return t[e]&&["withcoord","withdist","count","sort"].indexOf(e)!==-1}).forEach(function(e){"withcoord"===e||"withdist"===e?(r.push(e),delete t[e]):"count"!==e&&"sort"!==e||("count"===e&&r.push("count"),r.push(t[e])),delete t[e]}),r.length>0&&(e.options=r)}function o(e,t){e.options=["withscores"],t.limit&&(e.limit=t.limit,delete t.limit)}function s(e){return e.map(function(e){return e.map(function(e){return parseFloat(e)})})}function u(e){return Array.isArray(e[0])?e.map(function(e){var t,r={name:e[0]};for(t=1;t<e.length;t++)Array.isArray(e[t])?r.coordinates=e[t].map(function(e){return parseFloat(e)}):r.distance=parseFloat(e[t]);return r}):e.map(function(e){return{name:e}})}function l(e){return Array.isArray(e)?e:[e]}function c(e){return e.map(function(e){return parseInt(e)})}function a(e){var t=null,r=[];return e.forEach(function(e){null===t?t=e:(r.push({member:t,score:parseFloat(e)}),t=null)}),r}var d={getter:!0,required:["_id"]},f={getter:!0,required:["_id","field"]},h={getter:!0,required:["keys"]},p={getter:!0,required:["_id","member"]},y={getter:!0,required:["_id","cursor"],opts:["match","count"]},b={getter:!0,required:["_id","start","stop"],opts:o,mapResults:a},v={getter:!0,required:["_id","min","max"],opts:o,mapResults:a},m={required:["_id"]},z={required:["_id","value"]},g={required:["_id","field","value"]},w={required:["entries"]},k={append:z,bitcount:{getter:!0,required:["_id"],opts:["start","end"]},bitop:{required:["_id","operation","keys"]},bitpos:{getter:!0,required:["_id","bit"],opts:["start","end"]},dbsize:{getter:!0},decr:m,decrby:z,del:{required:["keys"]},exists:h,expire:{required:["_id","seconds"]},expireat:{required:["_id","timestamp"]},flushdb:{},geoadd:{required:["_id","points"]},geodist:{getter:!0,required:["_id","member1","member2"],opts:["unit"],mapResults:parseFloat},geohash:{getter:!0,required:["_id","members"]},geopos:{getter:!0,required:["_id","members"],mapResults:s},georadius:{getter:!0,required:["_id","lon","lat","distance","unit"],opts:n,mapResults:u},georadiusbymember:{getter:!0,required:["_id","member","distance","unit"],opts:n,mapResults:u},get:d,getbit:{getter:!0,required:["_id","offset"]},getrange:{getter:!0,required:["_id","start","end"]},getset:z,hdel:{required:["_id","fields"]},hexists:f,hget:f,hgetall:{getter:!0,required:["_id"]},hincrby:g,hincrbyfloat:{required:["_id","field","value"],mapResults:parseFloat},hkeys:d,hlen:d,hmget:{getter:!0,required:["_id","fields"]},hmset:{required:["_id","entries"]},hscan:y,hset:g,hsetnx:g,hstrlen:f,hvals:d,incr:m,incrby:z,incrbyfloat:{required:["_id","value"],mapResults:parseFloat},keys:{getter:!0,required:["pattern"]},lindex:{getter:!0,required:["_id","index"]},linsert:{required:["_id","position","pivot","value"]},llen:d,lpop:m,lpush:{required:["_id","values"]},lpushx:z,lrange:{getter:!0,required:["_id","start","stop"]},lrem:{required:["_id","count","value"]},lset:{required:["_id","index","value"]},ltrim:{required:["_id","start","stop"]},mget:h,mset:w,msetnx:w,object:{getter:!0,required:["_id","subcommand"]},persist:m,pexpire:{required:["_id","milliseconds"]},pexpireat:{required:["_id","timestamp"]},pfadd:{required:["_id","elements"]},pfcount:h,pfmerge:{required:["_id","sources"]},ping:{getter:!0},psetex:{required:["_id","value","milliseconds"]},pttl:d,randomkey:{getter:!0},rename:{required:["_id","newkey"]},renamenx:{required:["_id","newkey"]},rpop:m,rpoplpush:{required:["source","destination"]},rpush:{required:["_id","values"]},rpushx:z,sadd:{required:["_id","members"]},scan:{getter:!0,required:["cursor"],opts:["match","count"]},scard:d,sdiff:{getter:!0,required:["_id","keys"]},sdiffstore:{required:["_id","keys","destination"]},set:{required:["_id","value"],opts:["ex","px","nx","xx"]},setex:{required:["_id","value","seconds"]},setnx:z,sinter:h,sinterstore:{required:["destination","keys"]},sismember:p,smembers:d,smove:{required:["_id","destination","member"]},sort:{getter:!0,required:["_id"],opts:["alpha","by","direction","get","limit"]},spop:{required:["_id"],opts:["count"],mapResults:l},srandmember:{getter:!0,required:["_id"],opts:["count"],mapResults:l},srem:{required:["_id","members"]},sscan:y,strlen:d,sunion:h,sunionstore:{required:["destination","keys"]},time:{getter:!0,mapResults:c},touch:{required:["keys"]},ttl:d,type:d,zadd:{required:["_id","elements"],opts:["nx","xx","ch","incr"]},zcard:d,zcount:{getter:!0,required:["_id","min","max"]},zincrby:{required:["_id","member","value"]},zinterstore:{required:["_id","keys"],opts:["weights","aggregate"]},zlexcount:{getter:!0,required:["_id","min","max"]},zrange:b,zrangebylex:{getter:!0,required:["_id","min","max"],opts:["limit"]},zrevrangebylex:{getter:!0,required:["_id","min","max"],opts:["limit"]},zrangebyscore:v,zrank:p,zrem:{required:["_id","members"]},zremrangebylex:{required:["_id","min","max"]},zremrangebyrank:{required:["_id","start","stop"]},zremrangebyscore:{required:["_id","min","max"]},zrevrange:b,zrevrangebyscore:v,zrevrank:p,zscan:y,zscore:{getter:!0,required:["_id","member"],mapResults:parseFloat},zunionstore:{required:["_id","keys"],opts:["weights","aggregate"]}};!function(){Object.keys(k).forEach(function(e){r.prototype[e]=function(){var t,r=Array.prototype.slice.call(arguments),n=null,o={controller:"ms",action:e},s={};if(r.length&&"function"==typeof r[r.length-1]&&(t=r.pop()),k[e].getter&&this.kuzzle.callbackRequired("MemoryStorage."+e,t),k[e].getter||(s.body={}),k[e].required&&k[e].required.forEach(function(t){var n=r.shift();if(void 0===n)throw new Error("MemoryStorage."+e+': Missing parameter "'+t+'"');i(s,k[e].getter,t,n)}),r.length>1)throw new Error("MemoryStorage."+e+": Too many parameters provided");if(1===r.length&&"object"!=typeof r[0]||Array.isArray(r[0]))throw new Error("MemoryStorage."+e+": Invalid optional parameter (expected an object)");if(r.length&&(n=Object.assign({},r[0]),Array.isArray(k[e].opts)&&k[e].opts.forEach(function(t){null!==n[t]&&void 0!==n[t]&&(i(s,k[e].getter,t,n[t]),delete n[t])})),"function"==typeof k[e].opts&&k[e].opts(s,n||{}),this.kuzzle.query(o,s,n,t&&function(r,i){return r?t(r):k[e].mapResults?t(null,k[e].mapResults(i.result)):void t(null,i.result)}),!k[e].getter)return this}})}(),e.exports=r},function(e,t,r){function i(e,t){return Object.defineProperties(this,{callback:{value:null,writable:!0},channel:{value:null,writable:!0},id:{value:u.v4()},lastRenewal:{value:null,writable:!0},notifier:{value:null,writable:!0},onDoneCB:{value:null,writable:!0},queue:{value:[],writable:!0},renewalDelay:{value:500},scope:{value:t&&t.scope?t.scope:"all"},state:{value:t&&t.state?t.state:"done"},subscribing:{value:!1,writable:!0},users:{value:t&&t.users?t.users:"none"},collection:{value:e,enumerable:!0},kuzzle:{value:e.kuzzle,enumerable:!0},filters:{value:null,enumerable:!0,writable:!0},headers:{value:JSON.parse(JSON.stringify(e.headers)),enumerable:!0,writable:!0},volatile:{value:t&&t.volatile?t.volatile:{},enumerable:!0,writable:!0},roomId:{value:null,enumerable:!0,writable:!0},subscribeToSelf:{value:!t||"boolean"!=typeof t.subscribeToSelf||t.subscribeToSelf,enumerable:!0,writable:!0}}),this.kuzzle.bluebird?this.kuzzle.bluebird.promisifyAll(this,{suffix:"Promise",filter:function(e,t,r,i){var n=["count"];return i&&n.indexOf(e)!==-1}}):this}function n(e){return e.error?this.callback(e.error):"jwtTokenExpired"===e.action?(this.kuzzle.jwtToken=void 0,this.kuzzle.emitEvent("jwtTokenExpired")):("document"===e.controller||"realtime"===e.controller&&"publish"===e.action?(e.type="document",e.document=new l(this.collection,e.result._id,e.result._source),delete e.result):"realtime"===e.controller&&(e.type="user",e.user={count:e.result.count},delete e.result),void(this.kuzzle.requestHistory[e.requestId]?(this.subscribeToSelf&&this.callback(null,e),delete this.kuzzle.requestHistory[e.requestId]):this.callback(null,e)))}function o(){for(var e;this.queue.length>0;)e=this.queue.shift(),this[e.action].apply(this,e.args)}function s(){return"connected"===this.kuzzle.state&&!this.subscribing}var u=r(5),l=r(2);i.prototype.count=function(e){var t;if(this.kuzzle.callbackRequired("Room.count",e),t=this.kuzzle.addHeaders({body:{roomId:this.roomId}},this.headers),!s.call(this))return void this.queue.push({action:"count",args:[e]});if(!this.roomId)throw new Error("Room.count: cannot count subscriptions on an inactive room");this.kuzzle.query(this.collection.buildQueryArgs("realtime","count"),t,function(t,r){e(t,r&&r.result.count)})},i.prototype.renew=function(e,t,r){var i=Date.now(),s={scope:this.scope,state:this.state,users:this.users},u=this;return"function"==typeof e&&(r=t,t=e,e=null),r||(r=u.onDoneCB),u.kuzzle.callbackRequired("Room.renew",t),u.lastRenewal&&i-u.lastRenewal<=u.renewalDelay?r&&r(new Error("Subscription already renewed less than "+u.renewalDelay+"ms ago")):(e&&(u.filters=e),"connected"!==u.kuzzle.state?(u.callback=t,u.onDoneCB=r,void(u.kuzzle.subscriptions.pending[u.id]=u)):u.subscribing?void u.queue.push({action:"renew",args:[e,t,r]}):(u.unsubscribe(),u.roomId=null,u.subscribing=!0,u.callback=t,u.onDoneCB=r,u.kuzzle.subscriptions.pending[u.id]=u,s.body=u.filters,s=u.kuzzle.addHeaders(s,this.headers),void u.kuzzle.query(u.collection.buildQueryArgs("realtime","subscribe"),s,{volatile:u.volatile},function(e,t){return delete u.kuzzle.subscriptions.pending[u.id],u.subscribing=!1,e?(u.queue=[],r&&r(new Error("Error during Kuzzle subscription: "+e.message))):(u.lastRenewal=i,u.roomId=t.result.roomId,u.channel=t.result.channel,u.kuzzle.subscriptions[u.roomId]||(u.kuzzle.subscriptions[u.roomId]={}),u.kuzzle.subscriptions[u.roomId][u.id]=u,u.notifier=n.bind(u),u.kuzzle.network.on(u.channel,u.notifier),o.call(u),void(r&&r(null,u)))})))},i.prototype.unsubscribe=function(){var e,t=this,r=t.roomId;return s.call(this)?(r&&(t.kuzzle.network.off(t.channel,this.notifier),1===Object.keys(t.kuzzle.subscriptions[r]).length?(delete t.kuzzle.subscriptions[r],0===Object.keys(t.kuzzle.subscriptions.pending).length?t.kuzzle.query(t.collection.buildQueryArgs("realtime","unsubscribe"),{body:{roomId:r}}):e=setInterval(function(){0===Object.keys(t.kuzzle.subscriptions.pending).length&&(t.kuzzle.subscriptions[r]||t.kuzzle.query(t.collection.buildQueryArgs("realtime","unsubscribe"),{body:{roomId:r}}),clearInterval(e))},100)):delete t.kuzzle.subscriptions[r][t.id],t.roomId=null),t):(t.queue.push({action:"unsubscribe",args:[]}),t)},i.prototype.setHeaders=function(e,t){return this.kuzzle.setHeaders.call(this,e,t),this},e.exports=i},function(e,t){function r(e,t,i,n,o,s,u){return Object.defineProperties(this,{collection:{value:e,enumerable:!0},total:{value:t,enumerable:!0},documents:{value:i,enumerable:!0},aggregations:{value:n||{},enumerable:!0},options:{value:o||{},enumerable:!0},filters:{value:s||{},enumerable:!0},fetchedDocument:{value:u instanceof r?i.length+u.fetchedDocument:i.length,enumerable:!0,writable:!0}}),this.collection.kuzzle.bluebird?this.collection.kuzzle.bluebird.promisifyAll(this,{suffix:"Promise",filter:function(e,t,r,i){var n=["fetchNext"];return i&&n.indexOf(e)!==-1}}):this}r.prototype.fetchNext=function(e){var t,r=Object.assign({},this.options);return r.previous=this,r.scrollId?this.fetchedDocument>=this.getTotal()?void e(null,null):("undefined"!=typeof r.from&&delete r.from,r.size&&delete r.size,void this.collection.scroll(r.scrollId,r,this.filters||{},e)):void 0!==r.from&&void 0!==r.size?(t=Object.assign({},this.filters),r.from+=r.size,r.from>=this.getTotal()?void e(null,null):void this.collection.search(t,r,e)):void e(new Error("Unable to retrieve next results from search: missing scrollId or from/size params"))},r.prototype.getDocuments=function(){return this.documents},r.prototype.getTotal=function(){return this.total},r.prototype.getAggregations=function(){return this.aggregations},r.prototype.getOptions=function(){return this.options},r.prototype.getFilters=function(){return this.filters},r.prototype.getCollection=function(){return this.collection},r.prototype.getFetchedDocument=function(){return this.fetchedDocument},e.exports=r},function(e,t){function r(){this.cbs=[],this.error=null,this.room=null}r.prototype.onDone=function(e){return this.error||this.room?e(this.error,this.room):this.cbs.push(e),this},r.prototype.done=function(e,t){this.error=e,this.room=t,this.cbs.forEach(function(r){r(e,t)})},e.exports=r},function(e,t,r){function i(e,t,i){if("undefined"!=typeof window){if("undefined"!=typeof WebSocket)return new(r(3))(e,t,i);if(window.io)return new(r(15))(e,t,i);throw new Error("Aborting: no websocket support detected and no socket.io library loaded either.")}return new(r(3))(e,t,i)}e.exports=i},function(e,t){function r(e,t,r){this.host=e,this.port=t,this.ssl=r,this.socket=null,this.connect=function(e,t){this.socket=window.io((this.ssl?"https://":"http://")+this.host+":"+this.port,{reconnection:e,reconnectionDelay:t,forceNew:!0})},this.onConnect=function(e){this.socket.on("connect",e)},this.onConnectError=function(e){this.socket.on("connect_error",e)},this.onDisconnect=function(e){this.socket.on("disconnect",e)},this.onReconnect=function(e){this.socket.on("reconnect",e)},this.once=function(e,t){this.socket.once(e,t)},this.on=function(e,t){this.socket.on(e,t)},this.off=function(e,t){this.socket.off(e,t)},this.send=function(e){this.socket.emit("kuzzle",e)},this.close=function(){this.socket.close(),this.socket=null}}e.exports=r},function(e,t,r){function i(e,t,r){if(n.call(this,e,t,r),Object.defineProperties(this,{deleteActionName:{value:"deleteProfile"},updateActionName:{value:"updateProfile"}}),e.kuzzle.bluebird)return e.kuzzle.bluebird.promisifyAll(this,{suffix:"Promise",filter:function(e,t,r,i){var n=["hydrate","save"];return i&&n.indexOf(e)!==-1}})}var n=r(1);i.prototype=Object.create(n.prototype,{constructor:{value:i}}),i.prototype.save=function(e,t){var r,i=this;if(!this.content.policies)throw new Error('Argument "policies" is mandatory in a profile. This argument contains an array of objects.');return e&&void 0===t&&"function"==typeof e&&(t=e,e=null),r=this.serialize(),i.kuzzle.query(i.Security.buildQueryArgs("createOrReplaceProfile"),r,e,t&&function(e){t(e,e?void 0:i)}),i},i.prototype.addPolicy=function(e){if("object"!=typeof e||"string"!=typeof e.roleId)throw new Error('Parameter "policies" must be an object containing at least a "roleId" member which must be a string.');return this.content.policies||(this.content.policies=[]),this.content.policies.push(e),this},i.prototype.setPolicies=function(e){if(!Array.isArray(e))throw new Error('Parameter "policies" must be an array of objects containing at least a "roleId" member which must be a string');return e.map(function(e){if("object"!=typeof e||"string"!=typeof e.roleId)throw new Error('Parameter "policies" must be an array of objects containing at least a "roleId" member which must be a string')}),this.content.policies=e,this},i.prototype.serialize=function(){var e={};return this.id&&(e._id=this.id),e.body=this.content,e},i.prototype.getPolicies=function(){return this.content.policies},e.exports=i},function(e,t,r){function i(e,t,r){if(n.call(this,e,t,r),Object.defineProperties(this,{deleteActionName:{value:"deleteRole"},updateActionName:{value:"updateRole"}}),e.kuzzle.bluebird)return e.kuzzle.bluebird.promisifyAll(this,{suffix:"Promise",filter:function(e,t,r,i){var n=["save"];return i&&n.indexOf(e)!==-1}})}var n=r(1);i.prototype=Object.create(n.prototype,{constructor:{value:i}}),i.prototype.save=function(e,t){var r=this.serialize(),i=this;return e&&void 0===t&&"function"==typeof e&&(t=e,e=null),i.kuzzle.query(this.Security.buildQueryArgs("createOrReplaceRole"),r,e,t&&function(e){t(e,e?void 0:i)}),this},e.exports=i},function(e,t,r){function i(e){return Object.defineProperty(this,"kuzzle",{value:e}),Object.defineProperty(this,"buildQueryArgs",{value:function(e){return{controller:"security",action:e}}}),this.kuzzle.bluebird?this.kuzzle.bluebird.promisifyAll(this,{suffix:"Promise",filter:function(e,t,r,i){var n=["role","profile","user","isActionAllowed"];return i&&n.indexOf(e)===-1}}):this}var n=r(17),o=r(16),s=r(4);i.prototype.fetchRole=function(e,t,r){var i,o=this;if(!e)throw new Error("Id parameter is mandatory for fetchRole function");r||"function"!=typeof t||(r=t,t=null),i={_id:e},o.kuzzle.callbackRequired("Security.fetchRole",r),o.kuzzle.query(this.buildQueryArgs("getRole"),i,t,function(e,t){r(e,e?void 0:new n(o,t.result._id,t.result._source))})},i.prototype.searchRoles=function(e,t,r){var i=this;r||"function"!=typeof t||(r=t,t=null),i.kuzzle.callbackRequired("Security.searchRoles",r),i.kuzzle.query(this.buildQueryArgs("searchRoles"),{body:e},t,function(e,t){var o;return e?r(e):(o=t.result.hits.map(function(e){return new n(i,e._id,e._source)}),void r(null,{total:t.result.total,roles:o}))})},i.prototype.createRole=function(e,t,r,i){var o=this,s={},u="createRole";if(!e||"string"!=typeof e)throw new Error("Security.createRole: cannot create a role without a role ID");i||"function"!=typeof r||(i=r,r=null),s._id=e,s.body=t,r&&(u=r.replaceIfExist?"createOrReplaceRole":"createRole"),o.kuzzle.query(this.buildQueryArgs(u),s,r,i&&function(e,t){i(e,e?void 0:new n(o,t.result._id,t.result._source))})},i.prototype.updateRole=function(e,t,r,i){var o=this,s={_id:e,body:t},u="updateRole";if(!e||"string"!=typeof e)throw new Error("Security.updateRole: cannot update a role without a role ID");return i||"function"!=typeof r||(i=r,r=null),o.kuzzle.query(this.buildQueryArgs(u),s,r,i&&function(r){i(r,r?void 0:new n(o,e,t))}),this},i.prototype.deleteRole=function(e,t,r){var i={_id:e};return r||"function"!=typeof t||(r=t,t=null),this.kuzzle.query(this.buildQueryArgs("deleteRole"),i,t,r&&function(e,t){r(e,e?void 0:t.result._id)}),this},i.prototype.role=function(e,t){return new n(this,e,t)},i.prototype.fetchProfile=function(e,t,r){var i,n=this;if(r||"function"!=typeof t||(r=t,t=null),!e||"string"!=typeof e)throw new Error("Id parameter is mandatory for fetchProfile function");i={_id:e},n.kuzzle.callbackRequired("Security.fetchProfile",r),n.kuzzle.query(this.buildQueryArgs("getProfile"),i,t,function(e,t){r(e,e?void 0:new o(n,t.result._id,t.result._source))})},i.prototype.searchProfiles=function(e,t,r){var i=this;r||"function"!=typeof t||(r=t,t=null),i.kuzzle.callbackRequired("Security.searchProfiles",r),i.kuzzle.query(this.buildQueryArgs("searchProfiles"),{body:e},t,function(e,t){var n;return e?r(e):(n=t.result.hits.map(function(e){return new o(i,e._id,e._source)}),void r(null,{total:t.result.total,profiles:n}))})},i.prototype.createProfile=function(e,t,r,i){var n=this,s={},u="createProfile";if(!e||"string"!=typeof e)throw new Error("Security.createProfile: cannot create a profile without a profile ID");i||"function"!=typeof r||(i=r,r=null),s._id=e,s.body=t,r&&(u=r.replaceIfExist?"createOrReplaceProfile":"createProfile"),n.kuzzle.query(this.buildQueryArgs(u),s,r,i&&function(e,t){i(e,e?void 0:new o(n,t.result._id,t.result._source))})},i.prototype.updateProfile=function(e,t,r,i){var n=this,s={},u="updateProfile";if(!e||"string"!=typeof e)throw new Error("Security.updateProfile: cannot update a profile without a profile ID");return i||"function"!=typeof r||(i=r,r=null),s._id=e,s.body=t,n.kuzzle.query(this.buildQueryArgs(u),s,r,i&&function(e,t){var r={};return e?i(e):(Object.keys(t.result._source).forEach(function(e){r[e]=t.result._source[e]}),void i(null,new o(n,t.result._id,r)))}),this},i.prototype.deleteProfile=function(e,t,r){var i={_id:e};return r||"function"!=typeof t||(r=t,t=null),this.kuzzle.query(this.buildQueryArgs("deleteProfile"),i,t,r&&function(e,t){r(e,e?void 0:t.result._id)}),this},i.prototype.profile=function(e,t){return new o(this,e,t)},i.prototype.fetchUser=function(e,t,r){var i={_id:e},n=this;if(!e||"string"!=typeof e)throw new Error("Id parameter is mandatory for fetchUser function");r||"function"!=typeof t||(r=t,t=null),n.kuzzle.callbackRequired("Security.fetchUser",r),n.kuzzle.query(this.buildQueryArgs("getUser"),i,t,function(e,t){r(e,e?void 0:new s(n,t.result._id,t.result._source))})},i.prototype.searchUsers=function(e,t,r){var i=this;r||"function"!=typeof t||(r=t,t=null),i.kuzzle.callbackRequired("Security.searchUsers",r),i.kuzzle.query(this.buildQueryArgs("searchUsers"),{body:e},t,function(e,t){var n;return e?r(e):(n=t.result.hits.map(function(e){return new s(i,e._id,e._source)}),void r(null,{total:t.result.total,users:n}))})},i.prototype.createUser=function(e,t,r,i){var n=this,o={_id:e,body:t},u="createUser";if(!e||"string"!=typeof e)throw new Error("Security.createUser: cannot create a user without a user ID");i||"function"!=typeof r||(i=r,r=null),r&&(u=r.replaceIfExist?"createOrReplaceUser":"createUser"),n.kuzzle.query(this.buildQueryArgs(u),o,null,i&&function(e,t){i(e,e?void 0:new s(n,t.result._id,t.result._source))})},i.prototype.createRestrictedUser=function(e,t,r,i){var n=this,o={_id:e,body:t};if(!e||"string"!=typeof e)throw new Error("Security.createRestrictedUser: cannot create a user without a user ID");if(t.profileIds)throw new Error("Security.createRestrictedUser: cannot provide profileIds");i||"function"!=typeof r||(i=r,r=null),n.kuzzle.query(this.buildQueryArgs("createRestrictedUser"),o,null,i&&function(e,t){i(e,e?void 0:new s(n,t.result._id,t.result._source))})},i.prototype.updateUser=function(e,t,r,i){var n=this,o={},u="updateUser";if(!e||"string"!=typeof e)throw new Error("Security.updateUser: cannot update an user without an user ID");return i||"function"!=typeof r||(i=r,r=null),o._id=e,o.body=t,n.kuzzle.query(this.buildQueryArgs(u),o,r,i&&function(e,t){i(e,e?void 0:new s(n,t.result._id,t.result._source))}),this},i.prototype.deleteUser=function(e,t,r){var i={_id:e};return r||"function"!=typeof t||(r=t,t=null),this.kuzzle.query(this.buildQueryArgs("deleteUser"),i,t,r&&function(e,t){r(e,e?void 0:t.result._id)}),this},i.prototype.user=function(e,t){return new s(this,e,t)},i.prototype.isActionAllowed=function(e,t,r,i,n){var o;if(!e||"object"!=typeof e)throw new Error("rights parameter is mandatory for isActionAllowed function");if(!t||"string"!=typeof t)throw new Error("controller parameter is mandatory for isActionAllowed function");if(!r||"string"!=typeof r)throw new Error("action parameter is mandatory for isActionAllowed function");return o=e.filter(function(e){return e.controller===t||"*"===e.controller}).filter(function(e){return e.action===r||"*"===e.action}).filter(function(e){return e.index===i||"*"===e.index}).filter(function(e){return e.collection===n||"*"===e.collection}),o.some(function(e){return"allowed"===e.value})?"allowed":o.some(function(e){return"conditional"===e.value})?"conditional":"denied"},i.prototype.getUserRights=function(e,t,r){var i={_id:e},n=this;if(!e||"string"!=typeof e)throw new Error("userId parameter is mandatory for getUserRights function");r||"function"!=typeof t||(r=t,t=null),n.kuzzle.callbackRequired("Kuzzle.getUserRights",r),this.kuzzle.query(this.buildQueryArgs("getUserRights"),i,t,r&&function(e,t){r(e,e?void 0:t.result.hits)})},e.exports=i},function(e,t,r){function i(e,t,r){var i=t&&r||0,n=t||[];e=e||{};var s=void 0!==e.clockseq?e.clockseq:l,d=void 0!==e.msecs?e.msecs:(new Date).getTime(),f=void 0!==e.nsecs?e.nsecs:a+1,h=d-c+(f-a)/1e4;if(h<0&&void 0===e.clockseq&&(s=s+1&16383),(h<0||d>c)&&void 0===e.nsecs&&(f=0),f>=1e4)throw new Error("uuid.v1(): Can't create more than 10M uuids/sec");c=d,a=f,l=s,d+=122192928e5;var p=(1e4*(268435455&d)+f)%4294967296;n[i++]=p>>>24&255,n[i++]=p>>>16&255,n[i++]=p>>>8&255,n[i++]=255&p;var y=d/4294967296*1e4&268435455;n[i++]=y>>>8&255,n[i++]=255&y,n[i++]=y>>>24&15|16,n[i++]=y>>>16&255,n[i++]=s>>>8|128,n[i++]=255&s;for(var b=e.node||u,v=0;v<6;++v)n[i+v]=b[v];return t?t:o(n)}var n=r(7),o=r(6),s=n(),u=[1|s[0],s[1],s[2],s[3],s[4],s[5]],l=16383&(s[6]<<8|s[7]),c=0,a=0;e.exports=i},function(e,t,r){function i(e,t,r){var i=t&&r||0;"string"==typeof e&&(t="binary"==e?new Array(16):null,e=null),e=e||{};var s=e.random||(e.rng||n)();if(s[6]=15&s[6]|64,s[8]=63&s[8]|128,t)for(var u=0;u<16;++u)t[i+u]=s[u];return t||o(s)}var n=r(7),o=r(6);e.exports=i}])});
//# sourceMappingURL=kuzzle.js.map