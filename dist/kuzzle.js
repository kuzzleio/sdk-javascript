!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.Kuzzle=t():e.Kuzzle=t()}(window,function(){return function(e){var t={};function r(n){if(t[n])return t[n].exports;var i=t[n]={i:n,l:!1,exports:{}};return e[n].call(i.exports,i,i.exports,r),i.l=!0,i.exports}return r.m=e,r.c=t,r.d=function(e,t,n){r.o(e,t)||Object.defineProperty(e,t,{configurable:!1,enumerable:!0,get:n})},r.r=function(e){Object.defineProperty(e,"__esModule",{value:!0})},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=6)}([function(e,t){function r(e,t,r,n){if(!t)throw new Error("A security document must have an id");if(Object.defineProperties(this,{kuzzle:{value:e.kuzzle},Security:{value:e},id:{value:t,enumerable:!0},content:{value:{},writable:!0,enumerable:!0},meta:{value:n||{},writable:!0,enumerable:!0}}),r&&this.setContent(r,!0),e.kuzzle.bluebird)return e.kuzzle.bluebird.promisifyAll(this,{suffix:"Promise",filter:function(e,t,r,n){return n&&-1!==["delete","update"].indexOf(e)}})}r.prototype.setContent=function(e){return this.content=e,this},r.prototype.serialize=function(){var e={};return this.id&&(e._id=this.id),e.body=this.content,e.meta=this.meta,e},r.prototype.delete=function(e,t){e&&void 0===t&&"function"==typeof e&&(t=e,e=null),this.kuzzle.query(this.Security.buildQueryArgs(this.deleteActionName),{_id:this.id},e,function(e,r){if(e)return!!t&&t(e);t&&t(null,r.result._id)})},r.prototype.update=function(e,t,r){var n={},i=this;if("object"!=typeof e)throw new Error('Parameter "content" must be a object');return t&&void 0===r&&"function"==typeof t&&(r=t,t=null),n._id=i.id,n.body=e,i.kuzzle.query(this.Security.buildQueryArgs(this.updateActionName),n,t,function(e,t){if(e)return!!r&&r(e);i.setContent(t.result._source),r&&r(null,i)}),this},e.exports=r},function(e,t,r){var n=r(7),i=r(8);e.exports=function(e,t,r){var o=t&&r||0;"string"==typeof e&&(t="binary"===e?new Array(16):null,e=null);var u=(e=e||{}).random||(e.rng||n)();if(u[6]=15&u[6]|64,u[8]=63&u[8]|128,t)for(var s=0;s<16;++s)t[o+s]=u[s];return t||i(u)}},function(e,t,r){"use strict";var n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},i=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}();function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var u=function e(t){var r=arguments.length>1&&void 0!==arguments[1]&&arguments[1];o(this,e),this.fn=t,this.once=r},s=function(){function e(){o(this,e),this._events={}}return i(e,[{key:"_exists",value:function(e,t){return Boolean(e.find(function(e){return e.fn===t}))}},{key:"listeners",value:function(e){return void 0===this._events[e]?[]:this._events[e].map(function(e){return e.fn})}},{key:"addListener",value:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(!e||!t)return this;var i=void 0===t?"undefined":n(t);if("function"!==i)throw new Error("Invalid listener type: expected a function, got a "+i);return void 0===this._events[e]&&(this._events[e]=[]),this._exists(this._events[e],t)||this._events[e].push(new u(t,r)),this}},{key:"on",value:function(e,t){return this.addListener(e,t)}},{key:"prependListener",value:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]&&arguments[2];return e&&t?(void 0===this._events[e]&&(this._events[e]=[]),this._exists(this._events[e],t)||(this._events[e]=[new u(t,r)].concat(this._events[e])),this):this}},{key:"addOnceListener",value:function(e,t){return this.addListener(e,t,!0)}},{key:"once",value:function(e,t){return this.addOnceListener(e,t)}},{key:"prependOnceListener",value:function(e,t){return this.prependListener(e,t,!0)}},{key:"removeListener",value:function(e,t){var r=this._events[e];if(!r||!r.length)return this;var n=r.findIndex(function(e){return e.fn===t});return-1!==n&&r.splice(n,1),0===r.length&&delete this._events[e],this}},{key:"removeAllListeners",value:function(e){return e?delete this._events[e]:this._events={},this}},{key:"emit",value:function(e){var t=this._events[e];if(void 0===t)return!1;for(var r=[],n=arguments.length,i=Array(n>1?n-1:0),o=1;o<n;o++)i[o-1]=arguments[o];var u=!0,s=!1,l=void 0;try{for(var c,a=t[Symbol.iterator]();!(u=(c=a.next()).done);u=!0){var d=c.value;d.fn.apply(d,i),d.once&&r.push(d.fn)}}catch(e){s=!0,l=e}finally{try{!u&&a.return&&a.return()}finally{if(s)throw l}}var f=!0,h=!1,p=void 0;try{for(var y,m=r[Symbol.iterator]();!(f=(y=m.next()).done);f=!0){var v=y.value;this.removeListener(e,v)}}catch(e){h=!0,p=e}finally{try{!f&&m.return&&m.return()}finally{if(h)throw p}}return!0}},{key:"eventNames",value:function(){return Object.keys(this._events)}},{key:"listenerCount",value:function(e){return this._events[e]&&this._events[e].length||0}}]),e}();e.exports=s},function(e,t){e.exports=class{constructor(e,t={},r={},n={}){this.kuzzle=e,this.request=t,this.options=r,this.response=n,this.fetched=n.hits&&n.hits.length||0,this.total=n.total&&n.total||0,this.controller="controller",this.searchAction="search",this.scrollAction="scroll"}next(){if(this.fetched>=this.total)return Promise.resolve(null);if(this.request.scroll)return this.kuzzle.query(Object.assign({},this.request,{scrollId:this.response.scrollId}),options).then(e=>(this.fetched+=e.hits.length,this.response=e,this));if(this.request.size&&this.request.sort){const e=Object.assign({},this.request,{search_after:[]}),t=this.response.hits&&this.response.hits[this.response.hits.length-1];for(const r of this.request.sort)"string"==typeof r?e.search_after.push(t._source[r]):e.search_after.push(t._source[Object.keys(r)[0]]);return this.kuzzle.query(e,this.options).then(e=>(this.fetched+=e.hits.length,this.response=e,this))}return this.request.from&&this.request.size?this.request.from>=this.response.total?Promise.resolve(null):this.kuzzle.query(Object.assign({},this.request,{from:this.fetched+1}),this.options).then(e=>(this.fetched+=e.hits.length,this.response=e,this)):Promise.reject(new Error("Unable to retrieve next results from search: missing scrollId or from/size params"))}}},function(e,t,r){var n=r(0);function i(e,t,r,i){if(n.call(this,e,t,r,i),Object.defineProperties(this,{deleteActionName:{value:"deleteUser"},updateActionName:{value:"updateUser"},credentials:{value:{},writable:!0,enumerable:!0}}),e.kuzzle.bluebird)return e.kuzzle.bluebird.promisifyAll(this,{suffix:"Promise",filter:function(e,t,r,n){return n&&-1!==["create","replace","saveRestricted","update","getProfiles"].indexOf(e)}})}i.prototype=Object.create(n.prototype,{constructor:{value:i}}),i.prototype.setProfiles=function(e){if(!Array.isArray(e)||"string"!=typeof e[0])throw new Error('Parameter "profileIds" must be an array of strings');return this.content.profileIds=e,this},i.prototype.setCredentials=function(e){if("object"!=typeof e)throw new Error('Parameter "credentials" must be a object');return this.credentials=e,this},i.prototype.addProfile=function(e){if("string"!=typeof e)throw new Error('Parameter "profileId" must be a string');return this.content.profileIds||(this.content.profileIds=[]),-1===this.content.profileIds.indexOf(e)&&this.content.profileIds.push(e),this},i.prototype.create=function(e,t){var r=this.creationSerialize(),n=this;if(!this.content.profileIds)throw new Error('Argument "profileIds" is mandatory in a user. This argument contains an array of profile identifiers.');return e&&void 0===t&&"function"==typeof e&&(t=e,e=null),this.kuzzle.query(this.Security.buildQueryArgs("createUser"),r,null,t&&function(e){t(e,e?void 0:n)}),this},i.prototype.replace=function(e,t){var r=this.serialize(),n=this;if(!this.content.profileIds)throw new Error('Argument "profileIds" is mandatory in a user. This argument contains an array of profile identifiers.');return e&&void 0===t&&"function"==typeof e&&(t=e,e=null),this.kuzzle.query(this.Security.buildQueryArgs("replaceUser"),r,null,t&&function(e){t(e,e?void 0:n)}),this},i.prototype.saveRestricted=function(e,t){var r=this.serialize(),n=this;return e&&void 0===t&&"function"==typeof e&&(t=e,e=null),n.kuzzle.query(this.Security.buildQueryArgs("createRestrictedUser"),r,e,t&&function(e){t(e,e?void 0:n)}),n},i.prototype.serialize=function(){return{_id:this.id,body:this.content,meta:this.meta}},i.prototype.creationSerialize=function(){return{_id:this.id,body:{content:this.content,credentials:this.credentials,meta:this.meta}}},i.prototype.getProfileIds=function(){return this.content.profileIds||[]},i.prototype.getProfiles=function(e,t){var r=this,n=[],i=!1;if(e&&!t&&"function"==typeof e&&(t=e,e=null),r.Security.kuzzle.callbackRequired("User.getProfiles",t),!r.content.profileIds)return t(null,n);r.content.profileIds.forEach(function(o){r.Security.fetchProfile(o,e,function(e,o){if(e){if(i)return;return i=!0,t(e)}n.push(o),n.length===r.content.profileIds.length&&t(null,n)})})},e.exports=i},function(e,t,r){"use strict";var n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},i=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),o=r(1),u=r(2),s=o(),l=function(e){function t(e,r){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t);var n=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return Object.defineProperties(n,{host:{value:e,enumerable:!0},port:{value:r&&"number"==typeof r.port?r.port:7512,enumerable:!0},ssl:{value:!(!r||"boolean"!=typeof r.sslConnection)&&r.sslConnection,enumerable:!0},queuing:{value:!1,writable:!0},reconnectionDelay:{value:r&&"number"==typeof r.reconnectionDelay?r.reconnectionDelay:1e3,enumerable:!0},autoReconnect:{value:!r||"boolean"!=typeof r.autoReconnect||r.autoReconnect,enumerable:!0},autoQueue:{value:!1,enumerable:!0,writable:!0},autoReplay:{value:!1,enumerable:!0,writable:!0},state:{value:"offline",enumerable:!0,writable:!0},offlineQueue:{value:[],enumerable:!0,writable:!0},queueFilter:{value:null,enumerable:!0,writable:!0},queueMaxSize:{value:500,enumerable:!0,writable:!0},queueTTL:{value:12e4,enumerable:!0,writable:!0},replayInterval:{value:10,enumerable:!0,writable:!0},offlineQueueLoader:{value:null,enumerable:!0,writable:!0}}),r&&(Object.keys(r).forEach(function(e){n.hasOwnProperty(e)&&Object.getOwnPropertyDescriptor(n,e).writable&&(n[e]=r[e])}),"auto"===r.offlineMode&&n.autoReconnect&&(n.autoQueue=n.autoReplay=!0)),n.wasConnected=!1,n.stopRetryingToConnect=!1,n.retrying=!1,n}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,u),i(t,[{key:"connect",value:function(){this.state="connecting",this.autoQueue&&this.startQueuing()}},{key:"clientConnected",value:function(){this.state="connected",this.emit(this.wasConnected?"reconnect":"connect"),this.wasConnected=!0,this.stopRetryingToConnect=!1,this.autoQueue&&this.stopQueuing(),this.autoReplay&&this.playQueue()}},{key:"clientDisconnected",value:function(){this.state="offline",this.autoQueue&&this.startQueuing(),this.emit("disconnect")}},{key:"clientNetworkError",value:function(e){var t=this;this.state="offline",this.autoQueue&&this.startQueuing(),this.emit("networkError",e),!this.autoReconnect||this.retrying||this.stopRetryingToConnect?this.emit("disconnect"):(this.retrying=!0,setTimeout(function(){t.retrying=!1,t.connect()},this.reconnectionDelay))}},{key:"flushQueue",value:function(){this.offlineQueue=[]}},{key:"playQueue",value:function(){"connected"===this.state&&(this._cleanQueue(),this._dequeue())}},{key:"startQueuing",value:function(){this.queuing=!0}},{key:"stopQueuing",value:function(){this.queuing=!1}},{key:"subscribe",value:function(e,t,r){var n=this;return"connected"!==this.state?Promise.reject(new Error("Not Connected")):this.query(e,t).then(function(e){return n.on(e.result.channel,function(e){e.fromSelf=void 0!==e.volatile&&e.volatile.sdkInstanceId===n.id,r(e)}),e.result})}},{key:"unsubscribe",value:function(e,t){return this.removeAllListeners(t),this.query(e)}},{key:"query",value:function(e,t){var r=this,n=t&&!1!==t.queuable||!0;return this.queueFilter&&(n=n&&this.queueFilter(e)),this.queuing&&n?(this._cleanQueue(),this.emit("offlineQueuePush",{query:e}),new Promise(function(t,n){r.offlineQueue.push({resolve:t,reject:n,ts:Date.now(),query:e})})):"connected"===this.state?this._emitRequest(e):this.constructor._discardRequest(e)}},{key:"_cleanQueue",value:function(){var e=this,t=Date.now(),r=-1;this.queueTTL>0&&(this.offlineQueue.forEach(function(n,i){n.ts<t-e.queueTTL&&(r=i)}),-1!==r&&this.offlineQueue.splice(0,r+1).forEach(function(t){e.emit("offlineQueuePop",t.query)})),this.queueMaxSize>0&&this.offlineQueue.length>this.queueMaxSize&&this.offlineQueue.splice(0,this.offlineQueue.length-this.queueMaxSize).forEach(function(t){e.emit("offlineQueuePop",t.query)})}},{key:"_dequeue",value:function(){var e=this,t={};if(this.offlineQueueLoader){if("function"!=typeof this.offlineQueueLoader)throw new Error("Invalid value for offlineQueueLoader property. Expected: function. Got: "+n(this.offlineQueueLoader));var r=this.offlineQueueLoader();if(!Array.isArray(r))throw new Error("Invalid value returned by the offlineQueueLoader function. Expected: array. Got: "+(void 0===r?"undefined":n(r)));this.offlineQueue=r.concat(this.offlineQueue).filter(function(e){if(!e.query||void 0===e.query.requestId||!e.query.action||!e.query.controller)throw new Error("Invalid offline queue request. One or more missing properties: requestId, action, controller.");return!t.hasOwnProperty(e.query.requestId)&&(t[e.query.requestId]=!0)})}!function t(){e.offlineQueue.length>0&&(e._emitRequest(e.offlineQueue[0].query).then(function(t){return e.offlineQueue[0].resolve(t)}).catch(function(t){return e.offlineQueue[0].reject(t)}),e.emit("offlineQueuePop",e.offlineQueue.shift()),setTimeout(function(){t()},Math.max(0,e.replayInterval)))}()}},{key:"_emitRequest",value:function(e){var t=this;return new Promise(function(r,n){t.once(e.requestId,function(i){var o=null;return"logout"!==e.action&&i.error&&"Token expired"===i.error.message&&t.emit("tokenExpired",e),i.error?(o=new Error(i.error.message),Object.assign(o,i.error),o.status=i.status,t.emit("queryError",o),n(o)):r(i)}),t.send(e)})}},{key:"id",get:function(){return s}}],[{key:"_discardRequest",value:function(e){return Promise.reject(new Error("Unable to execute request: not connected to a Kuzzle server.\nDiscarded request: "+JSON.stringify(e)))}}]),t}();e.exports=l},function(e,t,r){"use strict";var n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},i=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),o=function e(t,r,n){null===t&&(t=Function.prototype);var i=Object.getOwnPropertyDescriptor(t,r);if(void 0===i){var o=Object.getPrototypeOf(t);return null===o?void 0:e(o,r,n)}if("value"in i)return i.value;var u=i.get;return void 0!==u?u.call(n):void 0},u=r(1),s=r(2),l=r(9),c=r(11),a=r(13),d=r(14),f=r(16),h=r(17),p=r(20),y=r(4),m=r(21),v=function(e){function t(e,r){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t);var n=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));if(!e||""===e)throw new Error("host argument missing");if(Object.defineProperties(n,{eventActions:{value:["connected","discarded","disconnected","loginAttempt","networkError","offlineQueuePush","offlineQueuePop","queryError","reconnected","tokenExpired"]},autoResubscribe:{value:!r||"boolean"!=typeof r.autoResubscribe||r.autoResubscribe,enumerable:!0},defaultIndex:{value:r&&"string"==typeof r.defaultIndex?r.defaultIndex:void 0,writable:!0,enumerable:!0},jwt:{value:void 0,enumerable:!0,writable:!0},protocol:{value:r&&"string"==typeof r.protocol?r.protocol:"websocket",enumerable:!0},sdkVersion:{value:"5.0.11"},volatile:{value:{},enumerable:!0,writable:!0},collection:{value:new l(n),enumerable:!0},document:{value:new c(n),enumerable:!0},index:{value:new a(n),enumerable:!0},realtime:{value:new d(n),enumerable:!0},server:{value:new f(n),enumerable:!0}}),r){var i=!0,o=!1,u=void 0;try{for(var s,y=Object.keys(r)[Symbol.iterator]();!(i=(s=y.next()).done);i=!0){var v=s.value;n.hasOwnProperty(v)&&Object.getOwnPropertyDescriptor(n,v).writable&&(n[v]=r[v])}}catch(e){o=!0,u=e}finally{try{!i&&y.return&&y.return()}finally{if(o)throw u}}}return Object.defineProperty(n,"callbackRequired",{value:function(e,t){if(!t||"function"!=typeof t)throw new Error(e+": a callback argument is required for read queries")}}),Object.defineProperty(n,"security",{value:new h(n),enumerable:!0}),Object.defineProperty(n,"memoryStorage",{value:new p(n),enumerable:!0}),Object.defineProperty(n,"collections",{value:{},writable:!0}),Object.defineProperty(n,"eventTimeout",{value:r&&"number"==typeof r.eventTimeout?r.eventTimeout:200}),Object.defineProperty(n,"protectedEvents",{value:{connected:{timeout:n.eventTimeout},error:{timeout:n.eventTimeout},disconnected:{timeout:n.eventTimeout},reconnected:{timeout:n.eventTimeout},tokenExpired:{timeout:n.eventTimeout},loginAttempt:{timeout:n.eventTimeout}}}),n.network=m(n.protocol,e,r),Object.defineProperties(n,{autoQueue:{enumerable:!0,get:function(){return n.network.autoQueue},set:function(e){b("autoQueue","boolean",e),n.network.autoQueue=e}},autoReconnect:{enumerable:!0,get:function(){return n.network.autoReconnect}},autoReplay:{enumerable:!0,get:function(){return n.network.autoReplay},set:function(e){b("autoReplay","boolean",e),n.network.autoReplay=e}},host:{enumerable:!0,get:function(){return n.network.host}},offlineQueue:{enumerable:!0,get:function(){return n.network.offlineQueue}},offlineQueueLoader:{enumerable:!0,get:function(){return n.network.offlineQueueLoader},set:function(e){null!==e&&b("offlineQueueLoader","function",e),n.network.offlineQueueLoader=e}},port:{enumerable:!0,get:function(){return n.network.port}},queueFilter:{enumerable:!0,get:function(){return n.network.queueFilter},set:function(e){b("queueFilter","function",e),n.network.queueFilter=e}},queueMaxSize:{enumerable:!0,get:function(){return n.network.queueMaxSize},set:function(e){b("queueMaxSize","number",e),n.network.queueMaxSize=e}},queueTTL:{enumerable:!0,get:function(){return n.network.queueTTL},set:function(e){b("queueTTL","number",e),n.network.queueTTL=e}},replayInterval:{enumerable:!0,get:function(){return n.network.replayInterval},set:function(e){b("replayInterval","number",e),n.network.replayInterval=e}},reconnectionDelay:{enumerable:!0,get:function(){return n.network.reconnectionDelay}},sslConnection:{eumerable:!0,get:function(){return n.network.ssl}}}),n.network.addListener("offlineQueuePush",function(e){return n.emit("offlineQueuePush",e)}),n.network.addListener("offlineQueuePop",function(e){return n.emit("offlineQueuePop",e)}),n.network.addListener("queryError",function(e,t){return n.emit("queryError",e,t)}),n.network.addListener("tokenExpired",function(){n.unsetJwt(),n.emit("tokenExpired")}),n}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,s),i(t,[{key:"emit",value:function(e){var r,n=Date.now(),i=this.protectedEvents[e];if(i){if(i.lastEmitted&&i.lastEmitted>n-i.timeout)return!1;i.lastEmitted=n}for(var u=arguments.length,s=Array(u>1?u-1:0),l=1;l<u;l++)s[l-1]=arguments[l];(r=o(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"emit",this)).call.apply(r,[this,e].concat(s))}},{key:"connect",value:function(e){var t=this;"offline"===this.network.state?(this.network.connect(),this.network.addListener("connect",function(){t.emit("connected"),e&&e(null,t)}),this.network.addListener("networkError",function(r){var n=new Error("Unable to connect to kuzzle proxy server at "+t.network.host+":"+t.network.port);n.internal=r,t.emit("networkError",n),e&&e(n)}),this.network.addListener("disconnect",function(){t.disconnect(),t.emit("disconnected")}),this.network.addListener("reconnect",function(){t.jwt?t.checkToken(t.jwt,function(e,r){!e&&r.valid||t.unsetJwt(),t.emit("reconnected")}):t.emit("reconnected")}),this.network.on("discarded",function(e){return t.emit("discarded",e)})):e&&e(null,this)}},{key:"setJwt",value:function(e){if("string"==typeof e)this.jwt=e;else{if("object"!==(void 0===e?"undefined":n(e)))return this.emit("loginAttempt",{success:!1,error:"Invalid token argument: "+e}),this;if(!e.result||!e.result.jwt||"string"!=typeof e.result.jwt)return this.emit("loginAttempt",{success:!1,error:"Cannot find a valid JWT in the following object: "+JSON.stringify(e)}),this;this.jwt=e.result.jwt}return this.emit("loginAttempt",{success:!0}),this}},{key:"unsetJwt",value:function(){return this.jwt=void 0,this}},{key:"getJwt",value:function(){return this.jwt}},{key:"login",value:function(e){var t=this;if(!e||"string"!=typeof e)throw new Error("Kuzzle.login: strategy required");var r={strategy:e,body:{}},i=null;(arguments.length<=1?void 0:arguments[1])&&("object"===n(arguments.length<=1?void 0:arguments[1])?r.body=arguments.length<=1?void 0:arguments[1]:"number"==typeof(arguments.length<=1?void 0:arguments[1])||"string"==typeof(arguments.length<=1?void 0:arguments[1])?r.expiresIn=arguments.length<=1?void 0:arguments[1]:"function"==typeof(arguments.length<=1?void 0:arguments[1])&&(i=arguments.length<=1?void 0:arguments[1])),(arguments.length<=2?void 0:arguments[2])&&("number"==typeof(arguments.length<=2?void 0:arguments[2])||"string"==typeof(arguments.length<=2?void 0:arguments[2])?r.expiresIn=arguments.length<=2?void 0:arguments[2]:"function"==typeof(arguments.length<=2?void 0:arguments[2])&&(i=arguments.length<=2?void 0:arguments[2])),(arguments.length<=3?void 0:arguments[3])&&"function"==typeof(arguments.length<=3?void 0:arguments[3])&&(i=arguments.length<=3?void 0:arguments[3]),this.query({controller:"auth",action:"login"},r,{queuable:!1},function(e,r){e?(i&&i(e),t.emit("loginAttempt",{success:!1,error:e.message})):(r.result.jwt&&t.setJwt(r.result.jwt),i&&i(null,r.result))})}},{key:"createMyCredentials",value:function(e,t,r,n){return n||"function"!=typeof r||(n=r,r=null),this.query({controller:"auth",action:"createMyCredentials"},{strategy:e,body:t},r,function(e,t){"function"==typeof n&&n(e,e?void 0:t.result._source)}),this}},{key:"deleteMyCredentials",value:function(e,t,r){return r||"function"!=typeof t||(r=t,t=null),this.query({controller:"auth",action:"deleteMyCredentials"},{strategy:e},t,function(e,t){"function"==typeof r&&r(e,e?void 0:t.result)}),this}},{key:"getMyCredentials",value:function(e,t,r){r||"function"!=typeof t||(r=t,t=null),this.query({controller:"auth",action:"getMyCredentials"},{strategy:e},t,function(e,t){"function"==typeof r&&r(e,e?void 0:t.result)})}},{key:"updateMyCredentials",value:function(e,t,r,n){return n||"function"!=typeof r||(n=r,r=null),this.query({controller:"auth",action:"updateMyCredentials"},{strategy:e,body:t},r,function(e,t){"function"==typeof n&&n(e,e?void 0:t.result)}),this}},{key:"validateMyCredentials",value:function(e,t,r,n){n||"function"!=typeof r||(n=r,r=null),this.query({controller:"auth",action:"validateMyCredentials"},{strategy:e,body:t},r,function(e,t){"function"==typeof n&&n(e,e?void 0:t.result)})}},{key:"logout",value:function(e){var t=this,r={action:"logout",controller:"auth",requestId:u(),body:{}};return this.query({controller:"auth",action:"logout"},r,{queuable:!1},function(r){"function"==typeof e&&e(r,t)}),this.unsetJwt()}},{key:"checkToken",value:function(e,t){var r={body:{token:e}};this.callbackRequired("Kuzzle.checkToken",t),this.query({controller:"auth",action:"checkToken"},r,{queuable:!1},function(e,r){t(e,e?void 0:r.result)})}},{key:"whoAmI",value:function(e){var t=this;this.callbackRequired("Kuzzle.whoAmI",e),this.query({controller:"auth",action:"getCurrentUser"},{},{},function(r,n){e(r,r?void 0:new y(t.security,n.result._id,n.result._source,n.result._meta))})}},{key:"getMyRights",value:function(e,t){t||"function"!=typeof e||(t=e,e=null),this.callbackRequired("Kuzzle.getMyRights",t),this.query({controller:"auth",action:"getMyRights"},{},e,function(e,r){t(e,e?void 0:r.result.hits)})}},{key:"updateSelf",value:function(e,t,r){return r||"function"!=typeof t||(r=t,t=null),this.query({controller:"auth",action:"updateSelf"},{body:e},t,function(e,t){"function"==typeof r&&r(e,e?void 0:t.result)}),this}},{key:"addListener",value:function(e,r){if(-1===this.eventActions.indexOf(e))throw new Error("["+e+"] is not a known event. Known events: "+this.eventActions.toString());return o(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"addListener",this).call(this,e,r)}},{key:"flushQueue",value:function(){return this.network.flushQueue(),this}},{key:"disconnect",value:function(){this.network.close();var e=!0,t=!1,r=void 0;try{for(var n,i=Object.keys(this.collections)[Symbol.iterator]();!(e=(n=i.next()).done);e=!0){var o=n.value;delete this.collections[o]}}catch(e){t=!0,r=e}finally{try{!e&&i.return&&i.return()}finally{if(t)throw r}}}},{key:"query",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return!e||"object"!==(void 0===e?"undefined":n(e))||Array.isArray(e)?Promise.reject(new Error("Invalid request: "+JSON.stringify(e))):(e.options&&(e.options="wait_for"),e.volatile||(e.volatile={}),!e.volatile||"object"!==n(e.volatile)||Array.isArray(e.volatile)?Promise.reject(new Error("Invalid volatile argument received. Must be an object.")):(e.volatile.sdkInstanceId=this.network.id,e.volatile.sdkVersion=this.sdkVersion,void 0!==this.jwt&&"auth"!==e.controller&&"checkToken"!==e.action&&(e.jwt=this.jwt),this.network.query(e,t).then(function(e){return e.result})))}},{key:"startQueuing",value:function(){return this.network.startQueuing(),this}},{key:"stopQueuing",value:function(){return this.network.stopQueuing(),this}},{key:"replayQueue",value:function(){return this.playQueue()}},{key:"playQueue",value:function(){return this.network.playQueue(),this}},{key:"setDefaultIndex",value:function(e){if("string"!=typeof e)throw new Error("Invalid default index: ["+e+"] (an index name is expected)");if(0===e.length)throw new Error("Cannot set an empty index as the default index");return this.defaultIndex=e,this}}]),t}();function b(e,t,r){if("array"===t?!Array.isArray(r):(void 0===r?"undefined":n(r))!==t)throw new Error("Can only assign a "+t+' value to property "'+e+'"')}e.exports=v},function(e,t){var r="undefined"!=typeof crypto&&crypto.getRandomValues.bind(crypto)||"undefined"!=typeof msCrypto&&msCrypto.getRandomValues.bind(msCrypto);if(r){var n=new Uint8Array(16);e.exports=function(){return r(n),n}}else{var i=new Array(16);e.exports=function(){for(var e,t=0;t<16;t++)0==(3&t)&&(e=4294967296*Math.random()),i[t]=e>>>((3&t)<<3)&255;return i}}},function(e,t){for(var r=[],n=0;n<256;++n)r[n]=(n+256).toString(16).substr(1);e.exports=function(e,t){var n=t||0,i=r;return i[e[n++]]+i[e[n++]]+i[e[n++]]+i[e[n++]]+"-"+i[e[n++]]+i[e[n++]]+"-"+i[e[n++]]+i[e[n++]]+"-"+i[e[n++]]+i[e[n++]]+"-"+i[e[n++]]+i[e[n++]]+i[e[n++]]+i[e[n++]]+i[e[n++]]+i[e[n++]]}},function(e,t,r){const n=r(10);e.exports=class{constructor(e){this.kuzzle=e}create(e,t,r={}){return e?t?this.kuzzle.query({index:e,collection:t,controller:"collection",action:"create"},r):Promise.reject(new Error("Kuzzle.collection.create: collection is required")):Promise.reject(new Error("Kuzzle.collection.create: index is required"))}deleteSpecification(e,t,r={}){return e?t?this.kuzzle.query({index:e,collection:t,controller:"collection",action:"deleteSpecification"},r):Promise.reject(new Error("Kuzzle.collection.deleteSpecification: collection is required")):Promise.reject(new Error("Kuzzle.collection.deleteSpecification: index is required"))}exists(e,t,r={}){return e?t?this.kuzzle.query({index:e,collection:t,controller:"collection",action:"exists"},r):Promise.reject(new Error("Kuzzle.collection.exists: collection is required")):Promise.reject(new Error("Kuzzle.collection.exists: index is required"))}getMapping(e,t,r={}){return e?t?this.kuzzle.query({index:e,collection:t,controller:"collection",action:"getMapping"},r):Promise.reject(new Error("Kuzzle.collection.getMapping: collection is required")):Promise.reject(new Error("Kuzzle.collection.getMapping: index is required"))}getSpecifications(e,t,r={}){return e?t?this.kuzzle.query({index:e,collection:t,controller:"collection",action:"getSpecifications"},r):Promise.reject(new Error("Kuzzle.collection.getSpecifications: collection is required")):Promise.reject(new Error("Kuzzle.collection.getSpecifications: index is required"))}list(e,t={}){if(!e)return Promise.reject(new Error("Kuzzle.collection.list: index is required"));const r={index:e,controller:"collection",action:"list",from:t.from,size:t.size};return delete t.from,delete topions.size,this.kuzzle.query(r,t)}searchSpecifications(e={},t={}){const r={body:e,controller:"collection",action:"searchSpecifications"};for(const e of["from","size","scroll"])r[e]=t[e],delete t[e];return this.kuzzle.query(r,t).then(e=>new n(this.kuzzle,query,t,e))}truncate(e,t,r={}){return e?t?this.kuzzle.query({index:e,collection:t,controller:"colleciton",action:"truncate"},r):Promise.reject(new Error("Kuzzle.collection.truncate: collection is required")):Promise.reject(new Error("Kuzzle.collection.truncate: index is required"))}updateMapping(e,t,r,n={}){return e?t?this.kuzzle.query({index:e,collection:t,body:r,controller:"collection",action:"updateMapping"},n):Promise.reject(new Error("Kuzzle.collection.updateMapping: collection is required")):Promise.reject(new Error("Kuzzle.collection.updateMapping: index is required"))}updateSpecifications(e,t,r,n={}){return e?t?this.kuzzle.query({index:e,collection:t,body:r,controller:"collection",action:"updateSpecifications"},n):Promise.reject(new Error("Kuzzle.collection.updateSpecifications: collection is required")):Promise.reject(new Error("Kuzzle.collection.updateSpecifications: index is required"))}validateSpecifications(e,t={}){return this.kuzzle.query({body:e,controller:"collection",action:"validateSpecifications"},t)}}},function(e,t,r){const n=r(3);e.exports=class extends n{constructor(e,t,r,n){super(e,t,r,n),this.controller="collection",this.searchAction="searchSpecifications",this.scrollAction="scrollSpecifications"}}},function(e,t,r){const n=r(12);e.exports=class{constructor(e){this.kuzzle=e}count(e,t,r,n={}){if(!e)return Promise.reject(new Error("Kuzzle.document.count: index is required"));if(!t)return Promise.reject(new Error("Kuzzle.document.count: collection is required"));const i={index:e,collection:t,body:r,controller:"document",action:"count",includeTrash:n.includeTrash};return delete n.includeTrash,this.kuzzle.query(i,n).then(e=>e.count)}create(e,t,r,n,i={}){if(!e)return Promise.reject(new Error("Kuzzle.document.create: index is required"));if(!t)return Promise.reject(new Error("Kuzzle.document.create: collection is required"));const o={index:e,collection:t,_id:r,body:n,controller:"document",action:"create",refresh:i.refresh};return delete i.refresh,this.kuzzle.query(o,i)}createOrReplace(e,t,r,n,i={}){if(!e)return Promise.reject(new Error("Kuzzle.document.createOrReplace: index is required"));if(!t)return Promise.reject(new Error("Kuzzle.document.createOrReplace: collection is required"));if(!r)return Promise.reject(new Error("Kuzzle.document.createOrReplace: _id is required"));if(!n)return Promise.reject(new Error("Kuzzle.document.createOrReplace: body is required"));const o={index:e,collection:t,_id:r,body:n,controller:"document",action:"createOrReplace",refresh:i.refresh};return delete i.refresh,this.kuzzle.query(o,i)}delete(e,t,r,n={}){if(!e)return Promise.reject(new Error("Kuzzle.document.delete: index is required"));if(!t)return Promise.reject(new Error("Kuzzle.document.delete: collection is required"));if(!r)return Promise.reject(new Error("Kuzzle.document.delete: _id is required"));const i={index:e,collection:t,_id:r,body:body,controller:"document",action:"delete",refresh:n.refresh};return delete n.refresh,this.kuzzle.query(i,n)}deleteByQuery(e,t,r={},n={}){if(!e)return Promise.reject(new Error("Kuzzle.document.deleteByQuery: index is required"));if(!t)return Promise.reject(new Error("Kuzzle.document.deleteByQuery: collection is required"));const i={index:e,collection:t,body:r,controller:"document",action:"deleteByQuery",refresh:n.refresh};return delete n.refresh,this.kuzzle.query(i,n)}get(e,t,r,n={}){if(!e)return Promise.reject(new Error("Kuzzle.document.get: index is required"));if(!t)return Promise.reject(new Error("Kuzzle.document.get: collection is required"));const i={index:e,collection:t,_id:r,controller:"document",action:"get",includeTrash:n.includeTrash};return delete n.includeTrash,this.kuzzle.query(i,n)}mCreate(e,t,r,n={}){if(!e)return Promise.reject(new Error("Kuzzle.document.mCreate: index is required"));if(!t)return Promise.reject(new Error("Kuzzle.document.mCreate: collection is required"));if(!Array.isArray(r))return Promise.reject(new Error("Kuzzle.document.mCreate: documents must be an array"));const i={index:e,collection:t,body:{documents:r},controller:"document",action:"mCreate",refresh:n.refresh};return delete n.refresh,this.kuzzle.query(i,n)}mCreateOrReplace(e,t,r,n={}){if(!e)return Promise.reject(new Error("Kuzzle.document.mCreateOrReplace: index is required"));if(!t)return Promise.reject(new Error("Kuzzle.document.mCreateOrReplace: collection is required"));if(!Array.isArray(r))return Promise.reject(new Error("Kuzzle.document.mCreateOrReplace: documents must be an array"));const i={index:e,collection:t,body:{documents:r},controller:"document",action:"mCreateOrReplace",refresh:n.refresh};return delete n.refresh,this.kuzzle.query(i,n)}mDelete(e,t,r,n={}){if(!e)return Promise.reject(new Error("Kuzzle.document.mDelete: index is required"));if(!t)return Promise.reject(new Error("Kuzzle.document.mDelete: collection is required"));if(!Array.isArray(r))return Promise.reject(new Error("Kuzzle.document.mDelete: ids must be an array"));const i={index:e,collection:t,body:{ids:r},controller:"document",action:"mDelete",refresh:n.refresh};return delete n.refresh,this.kuzzle.query(i,n)}mGet(e,t,r,n={}){if(!e)return Promise.reject(new Error("Kuzzle.document.mGet: index is required"));if(!t)return Promise.reject(new Error("Kuzzle.document.mGet: collection is required"));if(!Array.isArray(r))return Promise.reject(new Error("Kuzzle.document.mGet: ids must be an array"));const i={index:e,collection:t,body:{ids:r},controller:"document",action:"mGet",includeTrash:n.includeTrash};return delete n.includeTrash,this.kuzzle.query(i,n)}mReplace(e,t,r,n={}){if(!e)return Promise.reject(new Error("Kuzzle.document.mReplace: index is required"));if(!t)return Promise.reject(new Error("Kuzzle.document.mReplace: collection is required"));if(!Array.isArray(r))return Promise.reject(new Error("Kuzzle.document.mReplace: documents must be an array"));const i={index:e,collection:t,body:{documents:r},controller:"document",action:"mReplace",refresh:n.refresh};return delete n.refresh,this.kuzzle.query(i,n)}mUpdate(e,t,r,n={}){if(!e)return Promise.reject(new Error("Kuzzle.document.mUpdate: index is required"));if(!t)return Promise.reject(new Error("Kuzzle.document.mUpdate: collection is required"));if(!Array.isArray(r))return Promise.reject(new Error("Kuzzle.document.mUpdate: documents must be an array"));const i={index:e,collection:t,body:{documents:r},controller:"document",action:"mUpdate",refresh:n.refresh};return delete n.refresh,this.kuzzle.query(i,n)}replace(e,t,r,n,i={}){if(!e)return Promise.reject(new Error("Kuzzle.document.replace: index is required"));if(!t)return Promise.reject(new Error("Kuzzle.document.replace: collection is required"));if(!r)return Promise.reject(new Error("Kuzzle.document.replace: _id is required"));if(!n)return Promise.reject(new Error("Kuzzle.document.replace: body is required"));const o={index:e,collection:t,_id:r,body:n,controller:"document",action:"replace",refresh:i.refresh};return delete i.refresh,this.kuzzle.query(o,i)}search(e,t,r={},i={}){if(!e)return Promise.reject(new Error("Kuzzle.document.search: index is required"));if(!t)return Promise.reject(new Error("Kuzzle.document.search: collection is required"));const o={index:e,collection:t,body:r,controller:"document",action:"search"};for(const e of["from","size","scroll","sort","includeTrash"])o[e]=i[e],delete i[e];return this.kuzzle.query(o,i).then(e=>new n(this.kuzzle,o,i,e))}update(e,t,r,n,i={}){if(!e)return Promise.reject(new Error("Kuzzle.document.update: index is required"));if(!t)return Promise.reject(new Error("Kuzzle.document.update: collection is required"));if(!r)return Promise.reject(new Error("Kuzzle.document.update: _id is required"));if(!n)return Promise.reject(new Error("Kuzzle.document.update: body is required"));const o={index:e,collection:t,_id:r,body:n,controller:"document",action:"update",refresh:i.refresh,retryOnConflict:i.retryOnConflict};return delete i.refresh,delete i.retryOnConflict,this.kuzzle.query(o,i)}validate(e,t,r,n={}){return e?t?r?this.kuzzle.query({index:e,collection:t,body:r,controller:"document",action:"validate"},n):Promise.reject(new Error("Kuzzle.document.validate: body is required")):Promise.reject(new Error("Kuzzle.document.validate: collection is required")):Promise.reject(new Error("Kuzzle.document.validate: index is required"))}}},function(e,t,r){const n=r(3);e.exports=class extends n{constructor(e,t,r,n){super(e,t,r,n),this.searchAction="search",this.scrollAction="scroll"}}},function(e,t){e.exports=class{constructor(e){this.kuzzle=e}create(e,t){return e?this.kuzzle.query({index:e,controller:"index",action:"create"},t):Promise.reject(new Error("Kuzzle.index.create: index required"))}delete(e,t){return e?this.kuzzle.query({index:e,controller:"index",action:"delete"},t):Promise.reject(new Error("Kuzzle.index.delete: index required"))}exists(e,t){return e?this.kuzzle.query({index:e,controller:"index",action:"exists"},t):Promise.reject(new Error("Kuzzle.index.exists: index required"))}getAutoRefresh(e,t){return e?this.kuzzle.query({index:e,controller:"index",action:"getAutoRefresh"},t):Promise.reject(new Error("Kuzzle.index.getAutoRefresh: index is required"))}list(e){return this.kuzzle.query({controller:"index",action:"list"},e)}mDelete(e,t){return Array.isArray(e)?this.kuzzle.query({controller:"index",action:"mDelete"},{body:{indexes:e}},t):Promise.reject(new Error("Kuzzle.index.mDelete: indexes must be an array"))}refresh(e,t){return e&&""!==e?this.kuzzle.query({index:e,controller:"index",action:"refresh"},t):Promise.reject(new Error("Kuzzle.index.refresh: index is required"))}refreshInternal(e){return this.kuzzle.query({controller:"index",action:"refreshInternal"},e)}setAutoRefresh(e,t,r){return void 0===t&&"boolean"==typeof e&&(t=e,e=this.kuzzle.defaultIndex),e&&""!==e?"boolean"!=typeof t?Promise.reject(new Error("Kuzzle.index.setAutoRefresh: autoRefresh must be a boolean")):this.kuzzle.query({index:e,controller:"index",action:"setAutoRefresh",body:{autoRefresh:t}},r):Promise.reject(new Error("Kuzzle.index.setAutoRefresh: index is required"))}}},function(e,t,r){const n=r(15);e.exports=class{constructor(e){this.kuzzle=e,this.subscriptions={filters:{},channels:{}}}count(e,t={}){return e?this.kuzzle.query({controller:"realtime",action:"count",body:{roomId:e}},t):Promise.reject(new Error("Kuzzle.realtime.count: roomId is required"))}join(e,t={}){return e?this.kuzzle.query({controller:"realtime",action:"join",body:{roomId:e}},t):Promise.reject(new Error("Kuzzle.realtime.join: roomId is required"))}list(e={}){return this.kuzzle.query({controller:"realtime",action:"list"},e)}publish(e,t,r,n={}){if(!e)return Promise.reject(new Error("Kuzzle.realtime.publish: index is required"));if(!t)return Promise.reject(new Error("Kuzzle.realtime.publish: collection is required"));if(!r)return Promise.reject(new Error("Kuzzle.realtime.publish: body is required"));const i={index:e,collection:t,body:r,controller:"realtime",action:"publish"};return this.kuzzle.query(i,n)}subscribe(e,t,r,i,o={}){const u=new n(this.kuzzle,e,t,r,i,o);return u.subscribe().then(e=>(this.subscriptions[u.id]||(this.subscriptions[u.id]=[]),this.subscriptions[u.id].push(u),e))}unsubscribe(e,t={}){const r=this.subscriptions[e];if(!r)return Promise.reject(new Error(`not subscribed to ${e}`));for(const e of r)e.removeListeners();return delete this.subscriptions[e],this.kuzzle.query({controller:"realtime",action:"unsubscribe",body:{roomId:e}},t)}validate(e,t,r,n={}){return e?t?r?this.kuzzle.query({index:e,collection:t,body:r,controller:"realtime",action:"validate"},n):Promise.reject(new Error("Kuzzle.realtime.publish: body is required")):Promise.reject(new Error("Kuzzle.realtime.publish: collection is required")):Promise.reject(new Error("Kuzzle.realtime.publish: index is required"))}}},function(e,t){e.exports=class{constructor(e,t,r,n,i,o={}){this.kuzzle=e,this.index=t,this.collection=r,this.callback=i,this.options=o,this.id=null,this.channel=null,this.request={index:t,collection:r,body:n,controller:"realtime",action:"subscribe"};for(const e of["state","scope","users","volatile"])this.request[e]=this.options[e],delete this.options[e];this.autoResubscribe="boolean"==typeof o.autoResubscribe?o.autoResubscribe:e.autoResubscribe,this.subscribeToSelf="boolean"!=typeof o.subscribeToSelf||o.subscribeToSelf}subscribe(){return this.kuzzle.query(this.request,this.options).then(e=>(this.id=e.roomId,this.channel=e.channel,this.kuzzle.network.on(this.channel,this._listenToChannelListener),this.kuzzle.addListener("reconnected",this._reSubscribeListener),e))}removeListeners(){this.kuzzle.removeListener("reconnected",this._reSubscribeListener),this.channel&&this.kuzzle.network.removeListener(this.channel,this._listenToChannelListener)}_listenToChannelListener(e){const t=void 0!==e.volatile&&e.volatile.sdkInstanceId===this.kuzzle.network.id;!this.subscribeToSelf&&t||this.callback(e)}_reSubscribeListener(){if(this.autoResubscribe)return this.subscribe()}}},function(e,t){e.exports=class{constructor(e){this.kuzzle=e}adminExists(e){return this.kuzzle.query({controller:"server",action:"adminExists"},e).then(e=>e.exists)}getAllStats(e){return this.kuzzle.query({controller:"server",action:"getAllStats"},e)}getConfig(e){return this.kuzzle.query({controller:"server",action:"getConfig"},e)}getLastStats(e){return this.kuzzle.query({controller:"server",action:"getLastStats"},e)}info(e){return this.kuzzle.query({controller:"server",action:"info"},e)}now(e){return this.kuzzle.query({controller:"server",action:"now"},e)}}},function(e,t,r){var n=r(18),i=r(19),o=r(4);function u(e){return Object.defineProperty(this,"kuzzle",{value:e}),Object.defineProperty(this,"buildQueryArgs",{value:function(e){return{controller:"security",action:e}}}),this.kuzzle.bluebird?this.kuzzle.bluebird.promisifyAll(this,{suffix:"Promise",filter:function(e,t,r,n){return n&&-1===["role","profile","user","isActionAllowed"].indexOf(e)}}):this}u.prototype.fetchRole=function(e,t,r){var i,o=this;if(!e)throw new Error("Id parameter is mandatory for fetchRole function");r||"function"!=typeof t||(r=t,t=null),i={_id:e},o.kuzzle.callbackRequired("Security.fetchRole",r),o.kuzzle.query(this.buildQueryArgs("getRole"),i,t,function(e,t){r(e,e?void 0:new n(o,t.result._id,t.result._source,t.result._meta))})},u.prototype.searchRoles=function(e,t,r){var i=this;r||"function"!=typeof t||(r=t,t=null),i.kuzzle.callbackRequired("Security.searchRoles",r),i.kuzzle.query(this.buildQueryArgs("searchRoles"),{body:e},t,function(e,t){var o;if(e)return r(e);o=t.result.hits.map(function(e){return new n(i,e._id,e._source,e._meta)}),r(null,{total:t.result.total,roles:o})})},u.prototype.createRole=function(e,t,r,i){var o=this,u={},s="createRole";if(!e||"string"!=typeof e)throw new Error("Security.createRole: cannot create a role without a role ID");i||"function"!=typeof r||(i=r,r=null),u._id=e,u.body=t,r&&(s=r.replaceIfExist?"createOrReplaceRole":"createRole"),o.kuzzle.query(this.buildQueryArgs(s),u,r,i&&function(e,t){i(e,e?void 0:new n(o,t.result._id,t.result._source,t.result._meta))})},u.prototype.updateRole=function(e,t,r,i){var o=this,u={_id:e,body:t};if(!e||"string"!=typeof e)throw new Error("Security.updateRole: cannot update a role without a role ID");return i||"function"!=typeof r||(i=r,r=null),o.kuzzle.query(this.buildQueryArgs("updateRole"),u,r,i&&function(r,u){i(r,r?void 0:new n(o,e,t,u.result._meta))}),this},u.prototype.deleteRole=function(e,t,r){var n={_id:e};return r||"function"!=typeof t||(r=t,t=null),this.kuzzle.query(this.buildQueryArgs("deleteRole"),n,t,r&&function(e,t){r(e,e?void 0:t.result._id)}),this},u.prototype.role=function(e,t,r){return new n(this,e,t,r)},u.prototype.fetchProfile=function(e,t,r){var n,o=this;if(r||"function"!=typeof t||(r=t,t=null),!e||"string"!=typeof e)throw new Error("Id parameter is mandatory for fetchProfile function");n={_id:e},o.kuzzle.callbackRequired("Security.fetchProfile",r),o.kuzzle.query(this.buildQueryArgs("getProfile"),n,t,function(e,t){r(e,e?void 0:new i(o,t.result._id,t.result._source,t.result._meta))})},u.prototype.searchProfiles=function(e,t,r){var n=this;r||"function"!=typeof t||(r=t,t=null),n.kuzzle.callbackRequired("Security.searchProfiles",r),n.kuzzle.query(this.buildQueryArgs("searchProfiles"),{body:e},t,function(e,t){var o,u;if(e)return r(e);o=t.result.hits.map(function(e){return new i(n,e._id,e._source,e._meta)}),t.result.scrollId&&(u=t.result.scrollId),r(null,{total:t.result.total,profiles:o,scrollId:u})})},u.prototype.createProfile=function(e,t,r,n){var o=this,u={},s="createProfile";if(!e||"string"!=typeof e)throw new Error("Security.createProfile: cannot create a profile without a profile ID");n||"function"!=typeof r||(n=r,r=null),u._id=e,t&&(u.body={policies:t}),r&&(s=r.replaceIfExist?"createOrReplaceProfile":"createProfile"),o.kuzzle.query(this.buildQueryArgs(s),u,r,n&&function(e,t){n(e,e?void 0:new i(o,t.result._id,t.result._source,t.result._meta))})},u.prototype.updateProfile=function(e,t,r,n){var o=this,u={};if(!e||"string"!=typeof e)throw new Error("Security.updateProfile: cannot update a profile without a profile ID");return n||"function"!=typeof r||(n=r,r=null),u._id=e,t&&(u.body={policies:t}),o.kuzzle.query(this.buildQueryArgs("updateProfile"),u,r,n&&function(e,t){var r={};if(e)return n(e);Object.keys(t.result._source).forEach(function(e){r[e]=t.result._source[e]}),n(null,new i(o,t.result._id,r,t.result._meta))}),this},u.prototype.deleteProfile=function(e,t,r){var n={_id:e};return r||"function"!=typeof t||(r=t,t=null),this.kuzzle.query(this.buildQueryArgs("deleteProfile"),n,t,r&&function(e,t){r(e,e?void 0:t.result._id)}),this},u.prototype.scrollProfiles=function(e,t,r){var n={},o=this;if(!e)throw new Error("Security.scrollProfiles: scrollId is required");r||"function"!=typeof t||(r=t,t={}),this.kuzzle.callbackRequired("Security.scrollProfiles",r),n.scrollId=e,t&&t.scroll&&(n.scroll=t.scroll),this.kuzzle.query({controller:"security",action:"scrollProfiles"},n,t,function(t,n){var u=[];if(t)return r(t);n.result.hits.forEach(function(e){var t=new i(o,e._id,e._source,e._meta);t.version=e._version,u.push(t)}),r(null,{total:n.result.total,profiles:u,scrollId:e})})},u.prototype.profile=function(e,t,r){return new i(this,e,t,r)},u.prototype.fetchUser=function(e,t,r){var n={_id:e},i=this;if(!e||"string"!=typeof e)throw new Error("Id parameter is mandatory for fetchUser function");r||"function"!=typeof t||(r=t,t=null),i.kuzzle.callbackRequired("Security.fetchUser",r),i.kuzzle.query(this.buildQueryArgs("getUser"),n,t,function(e,t){r(e,e?void 0:new o(i,t.result._id,t.result._source,t.result._meta))})},u.prototype.searchUsers=function(e,t,r){var n=this;r||"function"!=typeof t||(r=t,t=null),n.kuzzle.callbackRequired("Security.searchUsers",r),n.kuzzle.query(this.buildQueryArgs("searchUsers"),{body:e},t,function(e,t){var i,u=null;if(e)return r(e);i=t.result.hits.map(function(e){return new o(n,e._id,e._source,e._meta)}),t.result.scrollId&&(u=t.result.scrollId),r(null,{total:t.result.total,users:i,scrollId:u})})},u.prototype.createUser=function(e,t,r,n){var i=this,u={_id:e,body:t};n||"function"!=typeof r||(n=r,r=null),i.kuzzle.query(i.buildQueryArgs("createUser"),u,null,n&&function(e,t){n(e,e?void 0:new o(i,t.result._id,t.result._source,t.result._meta))})},u.prototype.replaceUser=function(e,t,r,n){var i=this,u={_id:e,body:t};if(!e||"string"!=typeof e)throw new Error("Security.replaceUser: cannot replace a user without a user ID");n||"function"!=typeof r||(n=r,r=null),i.kuzzle.query(this.buildQueryArgs("replaceUser"),u,r,n&&function(e,t){n(e,e?void 0:new o(i,t.result._id,t.result._source,t.result._meta))})},u.prototype.createRestrictedUser=function(e,t,r,n){var i=this,u={_id:e,body:t};if(t.profileIds)throw new Error("Security.createRestrictedUser: cannot provide profileIds");n||"function"!=typeof r||(n=r,r=null),i.kuzzle.query(this.buildQueryArgs("createRestrictedUser"),u,null,n&&function(e,t){n(e,e?void 0:new o(i,t.result._id,t.result._source))})},u.prototype.updateUser=function(e,t,r,n){var i=this,u={};if(!e||"string"!=typeof e)throw new Error("Security.updateUser: cannot update an user without an user ID");return n||"function"!=typeof r||(n=r,r=null),u._id=e,u.body=t,i.kuzzle.query(this.buildQueryArgs("updateUser"),u,r,n&&function(e,t){n(e,e?void 0:new o(i,t.result._id,t.result._source,t.result._meta))}),this},u.prototype.deleteUser=function(e,t,r){var n={_id:e};return r||"function"!=typeof t||(r=t,t=null),this.kuzzle.query(this.buildQueryArgs("deleteUser"),n,t,r&&function(e,t){r(e,e?void 0:t.result._id)}),this},u.prototype.scrollUsers=function(e,t,r){var n={},i=this;if(!e)throw new Error("Security.scrollUsers: scrollId is required");return r||"function"!=typeof t||(r=t,t={}),this.kuzzle.callbackRequired("Security.scrollUsers",r),n.scrollId=e,t&&t.scroll&&(n.scroll=t.scroll),this.kuzzle.query({controller:"security",action:"scrollUsers"},n,t,function(t,n){var u=[];if(t)return r(t);n.result.hits.forEach(function(e){var t=new o(i,e._id,e._source,e._meta);t.version=e._version,u.push(t)}),r(null,{total:n.result.total,users:u,scrollId:e})}),this},u.prototype.user=function(e,t,r){return new o(this,e,t,r)},u.prototype.isActionAllowed=function(e,t,r,n,i){var o;if(!e||"object"!=typeof e)throw new Error("rights parameter is mandatory for isActionAllowed function");if(!t||"string"!=typeof t)throw new Error("controller parameter is mandatory for isActionAllowed function");if(!r||"string"!=typeof r)throw new Error("action parameter is mandatory for isActionAllowed function");return(o=e.filter(function(e){return e.controller===t||"*"===e.controller}).filter(function(e){return e.action===r||"*"===e.action}).filter(function(e){return e.index===n||"*"===e.index}).filter(function(e){return e.collection===i||"*"===e.collection})).some(function(e){return"allowed"===e.value})?"allowed":o.some(function(e){return"conditional"===e.value})?"conditional":"denied"},u.prototype.getUserRights=function(e,t,r){var n={_id:e};if(!e||"string"!=typeof e)throw new Error("userId parameter is mandatory for getUserRights function");r||"function"!=typeof t||(r=t,t=null),this.kuzzle.callbackRequired("Kuzzle.getUserRights",r),this.kuzzle.query(this.buildQueryArgs("getUserRights"),n,t,r&&function(e,t){r(e,e?void 0:t.result.hits)})},u.prototype.createCredentials=function(e,t,r,n,i){return i||"function"!=typeof n||(i=n,n=null),this.kuzzle.query({controller:"security",action:"createCredentials"},{_id:t,strategy:e,body:r},n,function(e,t){e?i&&i(e):i&&i(null,t.result._source)}),this},u.prototype.deleteCredentials=function(e,t,r,n){return n||"function"!=typeof r||(n=r,r=null),this.kuzzle.query({controller:"security",action:"deleteCredentials"},{strategy:e,_id:t},r,"function"!=typeof n?null:function(e,t){e?n&&n(e):n&&n(null,t.result)}),this},u.prototype.getAllCredentialFields=function(e,t){t||"function"!=typeof e||(t=e,e=null),this.kuzzle.query({controller:"security",action:"getAllCredentialFields"},{},e,"function"!=typeof t?null:function(e,r){e?t&&t(e):t&&t(null,r.result)})},u.prototype.getCredentialFields=function(e,t,r){r||"function"!=typeof t||(r=t,t=null),this.kuzzle.query({controller:"security",action:"getCredentialFields"},{strategy:e},t,"function"!=typeof r?null:function(e,t){e?r&&r(e):r&&r(null,t.result)})},u.prototype.getCredentials=function(e,t,r,n){n||"function"!=typeof r||(n=r,r=null),this.kuzzle.query({controller:"security",action:"getCredentials"},{strategy:e,_id:t},r,"function"!=typeof n?null:function(e,t){e?n&&n(e):n&&n(null,t.result)})},u.prototype.hasCredentials=function(e,t,r,n){n||"function"!=typeof r||(n=r,r=null),this.kuzzle.query({controller:"security",action:"hasCredentials"},{strategy:e,_id:t},r,"function"!=typeof n?null:function(e,t){e?n&&n(e):n&&n(null,t.result)})},u.prototype.updateCredentials=function(e,t,r,n,i){return i||"function"!=typeof n||(i=n,n=null),this.kuzzle.query({controller:"security",action:"updateCredentials"},{strategy:e,_id:t,body:r},n,"function"!=typeof i?null:function(e,t){e?i&&i(e):i&&i(null,t.result)}),this},u.prototype.validateCredentials=function(e,t,r,n,i){i||"function"!=typeof n||(i=n,n=null),this.kuzzle.query({controller:"security",action:"validateCredentials"},{strategy:e,_id:t,body:r},n,"function"!=typeof i?null:function(e,t){e?i&&i(e):i&&i(null,t.result)})},e.exports=u},function(e,t,r){var n=r(0);function i(e,t,r,i){if(n.call(this,e,t,r,i),Object.defineProperties(this,{deleteActionName:{value:"deleteRole"},updateActionName:{value:"updateRole"}}),e.kuzzle.bluebird)return e.kuzzle.bluebird.promisifyAll(this,{suffix:"Promise",filter:function(e,t,r,n){return n&&-1!==["save"].indexOf(e)}})}i.prototype=Object.create(n.prototype,{constructor:{value:i}}),i.prototype.save=function(e,t){var r=this.serialize(),n=this;return e&&void 0===t&&"function"==typeof e&&(t=e,e=null),n.kuzzle.query(this.Security.buildQueryArgs("createOrReplaceRole"),r,e,t&&function(e){t(e,e?void 0:n)}),this},e.exports=i},function(e,t,r){var n=r(0);function i(e,t,r,i){if(n.call(this,e,t,r,i),Object.defineProperties(this,{deleteActionName:{value:"deleteProfile"},updateActionName:{value:"updateProfile"}}),e.kuzzle.bluebird)return e.kuzzle.bluebird.promisifyAll(this,{suffix:"Promise",filter:function(e,t,r,n){return n&&-1!==["hydrate","save"].indexOf(e)}})}i.prototype=Object.create(n.prototype,{constructor:{value:i}}),i.prototype.save=function(e,t){var r,n=this;if(!this.content.policies)throw new Error('Argument "policies" is mandatory in a profile. This argument contains an array of objects.');return e&&void 0===t&&"function"==typeof e&&(t=e,e=null),r=this.serialize(),n.kuzzle.query(n.Security.buildQueryArgs("createOrReplaceProfile"),r,e,t&&function(e){t(e,e?void 0:n)}),n},i.prototype.addPolicy=function(e){if("object"!=typeof e||"string"!=typeof e.roleId)throw new Error('Parameter "policies" must be an object containing at least a "roleId" member which must be a string.');return this.content.policies||(this.content.policies=[]),this.content.policies.push(e),this},i.prototype.setPolicies=function(e){if(!Array.isArray(e))throw new Error('Parameter "policies" must be an array of objects containing at least a "roleId" member which must be a string');return e.map(function(e){if("object"!=typeof e||"string"!=typeof e.roleId)throw new Error('Parameter "policies" must be an array of objects containing at least a "roleId" member which must be a string')}),this.content.policies=e,this},i.prototype.serialize=function(){var e={};return this.id&&(e._id=this.id),e.body=this.content,e.meta=this.meta,e},i.prototype.getPolicies=function(){return this.content.policies},e.exports=i},function(e,t){var r={getter:!0,required:["_id"]},n={getter:!0,required:["_id","field"]},i={getter:!0,required:["keys"]},o={getter:!0,required:["_id","member"]},u={getter:!0,required:["_id","cursor"],opts:["match","count"],mapResults:w},s={getter:!0,required:["_id","start","stop"],opts:y,mapResults:z},l={getter:!0,required:["_id","min","max"],opts:y,mapResults:z},c={required:["_id"]},a={required:["_id","value"]},d={append:a,bitcount:{getter:!0,required:["_id"],opts:["start","end"]},bitop:{required:["_id","operation","keys"]},bitpos:{getter:!0,required:["_id","bit"],opts:["start","end"]},dbsize:{getter:!0},decr:c,decrby:a,del:{required:["keys"]},exists:i,expire:{required:["_id","seconds"],mapResults:Boolean},expireat:{required:["_id","timestamp"],mapResults:Boolean},flushdb:{mapResults:b},geoadd:{required:["_id","points"]},geodist:{getter:!0,required:["_id","member1","member2"],opts:["unit"],mapResults:parseFloat},geohash:{getter:!0,required:["_id","members"]},geopos:{getter:!0,required:["_id","members"],mapResults:function(e){return e.map(function(e){return e.map(function(e){return parseFloat(e)})})}},georadius:{getter:!0,required:["_id","lon","lat","distance","unit"],opts:p,mapResults:m},georadiusbymember:{getter:!0,required:["_id","member","distance","unit"],opts:p,mapResults:m},get:r,getbit:{getter:!0,required:["_id","offset"]},getrange:{getter:!0,required:["_id","start","end"]},getset:a,hdel:{required:["_id","fields"]},hexists:{getter:!0,required:["_id","field"],mapResults:Boolean},hget:n,hgetall:{getter:!0,required:["_id"]},hincrby:{required:["_id","field","value"]},hincrbyfloat:{required:["_id","field","value"],mapResults:parseFloat},hkeys:r,hlen:r,hmget:{getter:!0,required:["_id","fields"]},hmset:{required:["_id","entries"],mapResults:b},hscan:u,hset:{required:["_id","field","value"],mapResults:Boolean},hsetnx:{required:["_id","field","value"],mapResults:Boolean},hstrlen:n,hvals:r,incr:c,incrby:a,incrbyfloat:{required:["_id","value"],mapResults:parseFloat},keys:{getter:!0,required:["pattern"]},lindex:{getter:!0,required:["_id","idx"]},linsert:{required:["_id","position","pivot","value"]},llen:r,lpop:c,lpush:{required:["_id","values"]},lpushx:a,lrange:{getter:!0,required:["_id","start","stop"]},lrem:{required:["_id","count","value"]},lset:{required:["_id","index","value"],mapResults:b},ltrim:{required:["_id","start","stop"],mapResults:b},mget:i,mset:{required:["entries"],mapResults:b},msetnx:{required:["entries"],mapResults:Boolean},object:{getter:!0,required:["_id","subcommand"]},persist:{required:["_id"],mapResults:Boolean},pexpire:{required:["_id","milliseconds"],mapResults:Boolean},pexpireat:{required:["_id","timestamp"],mapResults:Boolean},pfadd:{required:["_id","elements"],mapResults:Boolean},pfcount:i,pfmerge:{required:["_id","sources"],mapResults:b},ping:{getter:!0},psetex:{required:["_id","value","milliseconds"],mapResults:b},pttl:r,randomkey:{getter:!0},rename:{required:["_id","newkey"],mapResults:b},renamenx:{required:["_id","newkey"],mapResults:Boolean},rpop:c,rpoplpush:{required:["source","destination"]},rpush:{required:["_id","values"]},rpushx:a,sadd:{required:["_id","members"]},scan:{getter:!0,required:["cursor"],opts:["match","count"],mapResults:w},scard:r,sdiff:{getter:!0,required:["_id","keys"]},sdiffstore:{required:["_id","keys","destination"]},set:{required:["_id","value"],opts:["ex","px","nx","xx"],mapResults:b},setex:{required:["_id","value","seconds"],mapResults:b},setnx:{required:["_id","value"],mapResults:Boolean},sinter:i,sinterstore:{required:["destination","keys"]},sismember:{getter:!0,required:["_id","member"],mapResults:Boolean},smembers:r,smove:{required:["_id","destination","member"],mapResults:Boolean},sort:{getter:!0,required:["_id"],opts:["alpha","by","direction","get","limit"]},spop:{required:["_id"],opts:["count"],mapResults:v},srandmember:{getter:!0,required:["_id"],opts:["count"],mapResults:v},srem:{required:["_id","members"]},sscan:u,strlen:r,sunion:i,sunionstore:{required:["destination","keys"]},time:{getter:!0,mapResults:function(e){return e.map(function(e){return parseInt(e)})}},touch:{required:["keys"]},ttl:r,type:r,zadd:{required:["_id","elements"],opts:["nx","xx","ch","incr"]},zcard:r,zcount:{getter:!0,required:["_id","min","max"]},zincrby:{required:["_id","member","value"]},zinterstore:{required:["_id","keys"],opts:["weights","aggregate"]},zlexcount:{getter:!0,required:["_id","min","max"]},zrange:s,zrangebylex:{getter:!0,required:["_id","min","max"],opts:["limit"]},zrevrangebylex:{getter:!0,required:["_id","min","max"],opts:["limit"]},zrangebyscore:l,zrank:o,zrem:{required:["_id","members"]},zremrangebylex:{required:["_id","min","max"]},zremrangebyrank:{required:["_id","start","stop"]},zremrangebyscore:{required:["_id","min","max"]},zrevrange:s,zrevrangebyscore:l,zrevrank:o,zscan:u,zscore:{getter:!0,required:["_id","member"],mapResults:parseFloat},zunionstore:{required:["_id","keys"],opts:["weights","aggregate"]}};function f(e){return Object.defineProperties(this,{kuzzle:{value:e,enumerable:!0}}),this.kuzzle.bluebird?this.kuzzle.bluebird.promisifyAll(this,{suffix:"Promise",filter:function(e,t,r,n){return n&&-1===[].indexOf(e)}}):this}function h(e,t,r,n){t||"_id"===r?e[r]=n:e.body[r]=n}function p(e,t){var r=[];Object.keys(t).filter(function(e){return t[e]&&-1!==["withcoord","withdist","count","sort"].indexOf(e)}).forEach(function(e){"withcoord"===e||"withdist"===e?(r.push(e),delete t[e]):"count"!==e&&"sort"!==e||("count"===e&&r.push("count"),r.push(t[e])),delete t[e]}),r.length>0&&(e.options=r)}function y(e,t){e.options=["withscores"],t.limit&&(e.limit=t.limit,delete t.limit)}function m(e){return Array.isArray(e[0])?e.map(function(e){var t,r={name:e[0]};for(t=1;t<e.length;t++)Array.isArray(e[t])?r.coordinates=e[t].map(function(e){return parseFloat(e)}):r.distance=parseFloat(e[t]);return r}):e.map(function(e){return{name:e}})}function v(e){return Array.isArray(e)?e:[e]}function b(){}function z(e){var t=null,r=[];return e.forEach(function(e){null===t?t=e:(r.push({member:t,score:parseFloat(e)}),t=null)}),r}function w(e){return{cursor:e[0],values:e[1]}}Object.keys(d).forEach(function(e){f.prototype[e]=function(){var t,r=Array.prototype.slice.call(arguments),n=null,i={controller:"ms",action:e},o={};if(r.length&&"function"==typeof r[r.length-1]&&(t=r.pop()),d[e].getter&&this.kuzzle.callbackRequired("MemoryStorage."+e,t),d[e].getter||(o.body={}),d[e].required&&d[e].required.forEach(function(t){var n=r.shift();if(void 0===n)throw new Error("MemoryStorage."+e+': Missing parameter "'+t+'"');h(o,d[e].getter,t,n)}),r.length>1)throw new Error("MemoryStorage."+e+": Too many parameters provided");if(1===r.length&&"object"!=typeof r[0]||Array.isArray(r[0]))throw new Error("MemoryStorage."+e+": Invalid optional parameter (expected an object)");if(r.length&&(n=Object.assign({},r[0]),Array.isArray(d[e].opts)&&d[e].opts.forEach(function(t){null!==n[t]&&void 0!==n[t]&&(h(o,d[e].getter,t,n[t]),delete n[t])})),"function"==typeof d[e].opts&&d[e].opts(o,n||{}),this.kuzzle.query(i,o,n,t&&function(r,n){return r?t(r):d[e].mapResults?t(null,d[e].mapResults(n.result)):void t(null,n.result)}),!d[e].getter)return this}}),e.exports=f},function(e,t,r){e.exports=function(e,t,n){switch(e){case"websocket":if("undefined"!=typeof window&&"undefined"==typeof WebSocket)throw new Error("Aborting: no websocket support detected.");return new(r(22))(t,n);case"socketio":if(!window.io)throw new Error("Aborting: no socket.io library loaded.");return new(r(23))(t,n);default:throw new Error('Aborting: unknown protocol "'+e+'" (only "websocket" and "socketio" are available).')}}},function(e,t,r){"use strict";var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),i=r(5),o=void 0,u=function(e){function t(e,n){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t);var i=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,n));return o="undefined"!=typeof WebSocket?WebSocket:r(!function(){var e=new Error('Cannot find module "uws"');throw e.code="MODULE_NOT_FOUND",e}()),i.client=null,i.lasturl=null,i}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,i),n(t,[{key:"connect",value:function(){var e=this,r=(this.ssl?"wss://":"ws://")+this.host+":"+this.port,n="undefined"!=typeof window?void 0:{perMessageDeflate:!1};(function e(t,r,n){null===t&&(t=Function.prototype);var i=Object.getOwnPropertyDescriptor(t,r);if(void 0===i){var o=Object.getPrototypeOf(t);return null===o?void 0:e(o,r,n)}if("value"in i)return i.value;var u=i.get;return void 0!==u?u.call(n):void 0})(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"connect",this).call(this),r!==this.lasturl&&(this.wasConnected=!1,this.lasturl=r),this.client=new o(r,n),this.client.onopen=function(){e.clientConnected()},this.client.onclose=function(t,r){var n=void 0,i=r;if("number"==typeof t?n=t:(n=t.code,t.reason&&(i=t.reason)),1e3===n)e.clientDisconnected();else if(e.wasConnected){var o=new Error(i);o.status=n,e.clientNetworkError(o)}},this.client.onerror=function(t){var r=t instanceof Error&&t||new Error(t);e.clientNetworkError(r)},this.client.onmessage=function(t){var r=JSON.parse(t.data||t);r.room?e.emit(r.room,r):e.emit("discarded",r)}}},{key:"send",value:function(e){this.client&&this.client.readyState===this.client.OPEN&&this.client.send(JSON.stringify(e))}},{key:"close",value:function(){this.state="offline",this.removeAllListeners(),this.wasConnected=!1,this.client&&this.client.close(),this.client=null,this.stopRetryingToConnect=!0}}]),t}();e.exports=u},function(e,t,r){"use strict";var n=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),i=function e(t,r,n){null===t&&(t=Function.prototype);var i=Object.getOwnPropertyDescriptor(t,r);if(void 0===i){var o=Object.getPrototypeOf(t);return null===o?void 0:e(o,r,n)}if("value"in i)return i.value;var u=i.get;return void 0!==u?u.call(n):void 0},o=r(5),u=function(e){function t(e,r){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t);var n=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,r));return n.socket=null,n.forceDisconnect=!1,n.eventsWrapper={},n}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,o),n(t,[{key:"connect",value:function(){var e=this;i(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"connect",this).call(this),this.socket=window.io((this.ssl?"https://":"http://")+this.host+":"+this.port,{reconnection:this.autoReconnect,reconnectionDelay:this.reconnectionDelay,forceNew:!0}),this.socket.on("connect",function(){return e.clientConnected()}),this.socket.on("connect_error",function(t){return e.clientNetworkError(t)}),this.socket.on("disconnect",function(){if(e.forceDisconnect)e.clientDisconnected();else{var t=new Error("An error occurred, kuzzle may not be ready yet");t.status=500,e.clientNetworkError(t)}e.forceDisconnect=!1})}},{key:"addListener",value:function(e,r){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];return this._addEventWrapper(e,r,n),i(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"addListener",this).call(this,e,r,n),this}},{key:"prependListener",value:function(e,r){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];return this._addEventWrapper(e,r,n),i(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"prependListener",this).call(this,e,r,n)}},{key:"removeListener",value:function(e,r){return this.eventsWrapper[e]&&(this.eventsWrapper[e].listeners.delete(r),0===this.eventsWrapper[e].listeners.size&&(this.socket.off(e,this.eventsWrapper[e].wrapper),delete this.eventsWrapper[e]),i(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"removeListener",this).call(this,e,r)),this}},{key:"removeAllListeners",value:function(e){if(void 0!==e){if(void 0!==this.eventsWrapper[e]){var t=!0,r=!1,n=void 0;try{for(var i,o=this.eventsWrapper[e].listeners[Symbol.iterator]();!(t=(i=o.next()).done);t=!0){var u=i.value;this.removeListener(e,u)}}catch(e){r=!0,n=e}finally{try{!t&&o.return&&o.return()}finally{if(r)throw n}}}}else{var s=!0,l=!1,c=void 0;try{for(var a,d=Object.keys(this.eventsWrapper)[Symbol.iterator]();!(s=(a=d.next()).done);s=!0){var f=a.value;this.removeAllListeners(f)}}catch(e){l=!0,c=e}finally{try{!s&&d.return&&d.return()}finally{if(l)throw c}}}return this}},{key:"send",value:function(e){this.socket.emit("kuzzle",e)}},{key:"close",value:function(){this.forceDisconnect=!0,this.state="offline",this.socket.close(),this.socket=null}},{key:"_addEventWrapper",value:function(e,t){var r=this,n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(!this.eventsWrapper[e]){var i=function(){for(var t=arguments.length,n=Array(t),i=0;i<t;i++)n[i]=arguments[i];return r.emit.apply(r,[e].concat(n))};this.eventsWrapper[e]={wrapper:i,listeners:new Set},-1===["connect","connect_error","disconnect"].indexOf(e)&&(n?this.socket.once(e,i):this.socket.on(e,i))}this.eventsWrapper[e].listeners.add(t)}}]),t}();e.exports=u}])});
//# sourceMappingURL=kuzzle.js.map